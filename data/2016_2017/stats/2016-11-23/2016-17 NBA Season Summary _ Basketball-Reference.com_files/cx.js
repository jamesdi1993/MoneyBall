/*
 MIT License (c) copyright 2011-2013 original author or authors  MIT License (c) copyright 2011-2013 original author or authors */
var BSM;
(function(){if(!BSM||!BSM.requirejs){BSM?c=BSM:BSM={};var g,c,f;(function(d){function h(a,e){var b,l,d,m,p,c,h,k,f,n=e&&e.split("/"),g=v.map,r=g&&g["*"]||{};if(a&&"."===a.charAt(0))if(e){n=n.slice(0,n.length-1);a=n.concat(a.split("/"));for(k=0;k<a.length;k+=1)if(b=a[k],"."===b)a.splice(k,1),--k;else if(".."===b)if(1!==k||".."!==a[2]&&".."!==a[0])0<k&&(a.splice(k-1,2),k-=2);else break;a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||r)&&g){b=a.split("/");for(k=b.length;0<k;--k){l=b.slice(0,
k).join("/");if(n)for(f=n.length;0<f;--f)if(d=g[n.slice(0,f).join("/")])if(d=d[l]){m=d;p=k;break}if(m)break;!c&&r&&r[l]&&(c=r[l],h=k)}!m&&c&&(m=c,p=h);m&&(b.splice(0,p,m),a=b.join("/"))}return a}function b(a,e){return function(){return n.apply(d,A.call(arguments,0).concat([a,e]))}}function k(a){return function(e){return h(e,a)}}function a(a){return function(e){q[a]=e}}function e(a){if(x.call(u,a)){var e=u[a];delete u[a];w[a]=!0;m.apply(d,e)}if(!x.call(q,a)&&!x.call(w,a))throw Error("No "+a);return q[a]}
function l(a){var e,b=a?a.indexOf("!"):-1;-1<b&&(e=a.substring(0,b),a=a.substring(b+1,a.length));return[e,a]}function p(a){return function(){return v&&v.config&&v.config[a]||{}}}var m,n,r,t,q={},u={},v={},w={},x=Object.prototype.hasOwnProperty,A=[].slice;r=function(a,b){var d,m=l(a),p=m[0];a=m[1];p&&(p=h(p,b),d=e(p));p?a=d&&d.normalize?d.normalize(a,k(b)):h(a,b):(a=h(a,b),m=l(a),p=m[0],a=m[1],p&&(d=e(p)));return{f:p?p+"!"+a:a,n:a,pr:p,p:d}};t={require:function(a){return b(a)},exports:function(a){var e=
q[a];return"undefined"!==typeof e?e:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:p(a)}}};m=function(l,m,p,c){var h,k,f,n,g=[],v;c=c||l;if("function"===typeof p){m=!m.length&&p.length?["require","exports","module"]:m;for(n=0;n<m.length;n+=1)if(f=r(m[n],c),k=f.f,"require"===k)g[n]=t.require(l);else if("exports"===k)g[n]=t.exports(l),v=!0;else if("module"===k)h=g[n]=t.module(l);else if(x.call(q,k)||x.call(u,k)||x.call(w,k))g[n]=e(k);else if(f.p)f.p.load(f.n,b(c,!0),a(k),{}),g[n]=
q[k];else throw Error(l+" missing "+k);m=p.apply(q[l],g);l&&(h&&h.exports!==d&&h.exports!==q[l]?q[l]=h.exports:m===d&&v||(q[l]=m))}else l&&(q[l]=p)};g=c=n=function(a,b,l,p,c){if("string"===typeof a)return t[a]?t[a](b):e(r(a,b).f);a.splice||(v=a,b.splice?(a=b,b=l,l=null):a=d);"function"===typeof l&&(l=p,p=c);m(d,a,b||function(){},l);return n};n.config=function(a){v=a;v.deps&&n(v.deps,v.callback);return n};g._defined=q;f=function(a,e,b){e.splice||(b=e,e=[]);x.call(q,a)||x.call(u,a)||(u[a]=[a,e,b])};
f.amd={jQuery:!0}})();BSM.requirejs=g;BSM.require=c;BSM.define=f}})();BSM.require.config({baseUrl:function(){}(),packages:[{name:"when",main:"when",location:"node_modules/when"}]});BSM.define("main",[],function(){function g(d){if("function"==typeof d)try{d()}catch(c){console&&console.error("failed to execute command: ",c)}}var c=window.bsm_tag=window.bsm_tag||{run:[]},f=c.run||[];f.push=function(d){return g(d)};(function(){c.sync=!0;for(var d;d=f.shift();)g(d)})();return f});
(function(g){BSM.define("when/when",["require"],function(c){function f(a,e,l,d){return(a instanceof h?a:b(a)).then(e,l,d)}function d(a){return new h(a,G.PromiseStatus&&G.PromiseStatus())}function h(e,b){function l(e){if(g){var d=g;g=C;f=a(h,e);x(function(){b&&n(f,b);k(d,f)})}}function d(a){l(new p(a))}function c(a){if(g){var e=g;x(function(){k(e,new m(a))})}}var h,f,g=[];h=this;this._status=b;this.inspect=function(){return f?f.inspect():{state:"pending"}};this._when=function(a,e,b,l,d){function m(p){p._when(a,
e,b,l,d)}g?g.push(m):x(function(){m(f)})};try{e(l,d,c)}catch(r){d(r)}}function b(a){return d(function(e){e(a)})}function k(a,e){for(var b=0;b<a.length;b++)a[b](e)}function a(a,b){if(b===a)return new p(new TypeError);if(b instanceof h)return b;try{var d=b===Object(b)&&b.then;return"function"===typeof d?e(d,b):new l(b)}catch(m){return new p(m)}}function e(a,e){return d(function(b,l){x(function(){try{J(a,e,b,l)}catch(d){l(d)}})})}function l(a){this.value=a}function p(a){this.value=a}function m(a){this.value=
a}function n(a,e){a.then(function(){e.fulfilled()},function(a){e.rejected(a)})}function g(a){return a&&"function"===typeof a.then}function t(a,e,b,l,m){return f(a,function(a){return d(function(b,l,d){function m(a){r(a)}function p(a){g(a)}var c,h,k,n,g,r,q,t;q=a.length>>>0;c=Math.max(0,Math.min(e,q));k=[];h=q-c+1;n=[];if(c)for(r=function(a){n.push(a);--h||(g=r=z,l(n))},g=function(a){k.push(a);--c||(g=r=z,b(k))},t=0;t<q;++t)t in a&&f(a[t],p,m,d);else b(k)}).then(b,l,m)})}function q(a,e,b,l){return u(a,
z).then(e,b,l)}function u(a,e,b){return f(a,function(a){return new h(function(l,d,m){function p(a,k){f(a,e,b).then(function(a){c[k]=a;--h||l(c)},d,m)}var c,k,h,n;h=k=a.length>>>0;c=[];if(h)for(n=0;n<k;n++)n in a?p(a[n],n):--h;else l(c)})})}function v(a){return{state:"fulfilled",value:a}}function w(a){return{state:"rejected",reason:a}}function x(a){1===I.push(a)&&F(A)}function A(){k(I);I=[]}function z(a){return a}function B(a){"function"===typeof G.reportUnhandled?G.reportUnhandled():x(function(){throw a;
});throw a;}f.promise=d;f.resolve=b;f.reject=function(a){return f(a,function(a){return new p(a)})};f.defer=function(){var a,e,l;a={promise:C,resolve:C,reject:C,notify:C,resolver:{resolve:C,reject:C,notify:C}};a.promise=e=d(function(d,m,c){a.resolve=a.resolver.resolve=function(a){if(l)return b(a);l=!0;d(a);return e};a.reject=a.resolver.reject=function(a){if(l)return b(new p(a));l=!0;m(a);return e};a.notify=a.resolver.notify=function(a){c(a);return a}});return a};f.join=function(){return u(arguments,
z)};f.all=q;f.map=function(a,e){return u(a,e)};f.reduce=function(a,e){var b=J(E,arguments,1);return f(a,function(a){var l;l=a.length;b[0]=function(a,b,d){return f(a,function(a){return f(b,function(b){return e(a,b,d,l)})})};return H.apply(a,b)})};f.settle=function(a){return u(a,v,w)};f.any=function(a,e,b,l){return t(a,1,function(a){return e?e(a[0]):a[0]},b,l)};f.some=t;f.isPromise=g;f.isPromiseLike=g;y=h.prototype;y.then=function(a,e,b){var l=this;return new h(function(d,m,p){l._when(d,p,a,e,b)},this._status&&
this._status.observed())};y["catch"]=y.otherwise=function(a){return this.then(C,a)};y["finally"]=y.ensure=function(a){function e(){return b(a())}return"function"===typeof a?this.then(e,e).yield(this):this};y.done=function(a,e){this.then(a,e)["catch"](B)};y.yield=function(a){return this.then(function(){return a})};y.tap=function(a){return this.then(a).yield(this)};y.spread=function(a){return this.then(function(e){return q(e,function(e){return a.apply(C,e)})})};y.always=function(a,e){return this.then(a,
a,e)};D=Object.create||function(a){function e(){}e.prototype=a;return new e};l.prototype=D(y);l.prototype.inspect=function(){return v(this.value)};l.prototype._when=function(a,e,b){try{a("function"===typeof b?b(this.value):this.value)}catch(l){a(new p(l))}};p.prototype=D(y);p.prototype.inspect=function(){return w(this.value)};p.prototype._when=function(a,e,b,l){try{a("function"===typeof l?l(this.value):this)}catch(d){a(new p(d))}};m.prototype=D(y);m.prototype._when=function(a,e,b,l,d){try{e("function"===
typeof d?d(this.value):this.value)}catch(m){e(m)}};var y,D,H,E,J,F,I,G,K,C;I=[];G="undefined"!==typeof console?console:f;if("object"===typeof process&&process.nextTick)F=process.nextTick;else if(y="function"===typeof MutationObserver&&MutationObserver||"function"===typeof WebKitMutationObserver&&WebKitMutationObserver)F=function(a,e,b){var l=a.createElement("div");(new e(b)).observe(l,{attributes:!0});return function(){l.setAttribute("x","x")}}(document,y,A);else try{F=c("vertx").runOnLoop||c("vertx").runOnContext}catch(L){K=
setTimeout,F=function(a){K(a,0)}}c=Function.prototype;y=c.call;J=c.bind?y.bind(y):function(a,e){return a.apply(e,E.call(arguments,2))};c=[];E=c.slice;H=c.reduce||function(a){var e,b,l,d;d=0;e=Object(this);l=e.length>>>0;b=arguments;if(1>=b.length)for(;;){if(d in e){b=e[d++];break}if(++d>=l)throw new TypeError;}else b=b[1];for(;d<l;++d)d in e&&(b=a(b,e[d],d,e));return b};return f})})("function"===typeof BSM.define&&BSM.define.amd?BSM.define:function(g){module.exports=g(require)});
BSM.define("when",["when/when"],function(g){return g});BSM.define("window",[],function(){return window});BSM.define("utils/localstorage",["window"],function(g){var c;try{var f="localStorage"in g&&null!==g.localStorage&&g.localStorage,d;f.setItem("cx-lscheck","test");d=f.getItem("cx-lscheck");f.removeItem("cx-lscheck");c="test"===d?f:!1}catch(h){c=!1}return c});BSM.define("document",[],function(){return window.document});
BSM.define("utils/script",["when","document"],function(g,c){function f(d,h,b){var k=c.getElementsByTagName("script")[0],a=c.createElement("script");a.onload=a.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(this.onload=this.onreadystatechange=this.onerror=null,h(this))};a.onerror=function(a){this.onload=this.onreadystatechange=this.onerror=null;b(a)};a.src=d;k.parentNode.insertBefore(a,k)}return function(d){var c=g.defer();f(d,c.resolver.resolve,
c.resolver.reject);return c.promise}});BSM.define("utils/objects",[],function(){return{$isArray:function(g){return"[object Array]"===Object.prototype.toString.call(g)},$isObject:function(g){return null!=g&&"object"===typeof g}}});
BSM.define("utils/polyfill",[],function(){Array.prototype.indexOf=function(){function g(c,f){var d,h=Object(this),b=h.length>>>0;d=+f||0;if(null==this)throw new TypeError('"this" is null or not defined');if(0===b)return-1;Infinity===Math.abs(d)&&(d=0);if(d>=b)return-1;for(d=Math.max(0<=d?d:b-Math.abs(d),0);d<b;){if(d in h&&h[d]===c)return d;d++}return-1}return"function"==typeof Array.prototype.indexOf?Array.prototype.indexOf:g}();Array.prototype.forEach=function(){function g(c,f){if(null==this)throw new TypeError(" this is null or not defined");
if("function"!==typeof c)throw new TypeError(c+" is not a function");for(var d=Object(this),h=d.length>>>0,b=0,k=1<arguments.length?f:void 0;b<h;)b in d&&c.call(k,d[b],b,d),b++}return"function"==typeof Array.prototype.forEach?Array.prototype.forEach:g}();Array.prototype.map=function(){function g(c,f){if(null==this)throw new TypeError(" this is null or not defined");if("function"!==typeof c)throw new TypeError(c+" is not a function");for(var d=Object(this),h=d.length>>>0,b=1<arguments.length?f:void 0,
k=0,a=Array(h);k<h;)k in d&&(a[k]=c.call(b,d[k],k,d)),k++;return a}return"function"==typeof Array.prototype.map?Array.prototype.map:g}();Object.create=function(){function g(c){if(1<arguments.length)throw Error("Second argument not supported");if("object"!=typeof c)throw TypeError("Argument must be an object");var f=function(){};f.prototype=c;var d=new f;f.prototype=null;return d}return"function"==typeof Object.create?Object.create:g}();Object.keys=function(){function g(c){if("object"!==typeof c&&
("function"!==typeof c||null===c))throw new TypeError("Object.keys -- invalid argument");var f=[],d;for(d in c)c.hasOwnProperty(c)&&f.push(d);return f}return"function"==typeof Object.keys?Object.keys:g}()});
BSM.define("utils",["when","utils/localstorage","utils/script","utils/objects","utils/polyfill"],function(g,c,f,d,h){function b(a,e,l){e=e||"=";l=l||"&";var c=[],k,h;for(h in a)if(k=a[h],a.hasOwnProperty(h)&&h){if("object"===typeof k)k=d.$isArray(k)?k.join(l+h+e):b(k,e,l);else if("boolean"===typeof k)k=k?"y":"n";else if(null==k||void 0===k)k="";"string"!==typeof k&&"number"!==typeof k||c.push(h+e+k)}return c.join(l)}function k(a,e){var b=this,l=Array.prototype.slice.call(arguments,0);return function(){var e=
l.slice(1);e.push.apply(e,Array.prototype.slice.call(arguments,0));return a.apply(b,e)}}function a(a,e,b){var l=Array.prototype.slice.call(arguments,1);return k.apply(a,l)}function e(a,e){for(var b in e)e.hasOwnProperty(b)&&(a[b]=e[b]);return a}function l(a){return function(e,b,l){isNaN(l)&&(l=Infinity);isNaN(b)&&(b=1);e=a(e/b)*b;return e<l?e:l}}return{$script:f,$localStorage:c,$isArray:d.$isArray,isObject:d.$isObject,$toString:b,toQuery:function(a){var e=[],b;for(b in a)a.hasOwnProperty(b)&&(e.length&&
e.push("&"),e.push(b,"=",a[b]));return e.join("")},$bindTo:k,$bind:a,$isReady:function(a){return!(a.readyState&&"complete"!==a.readyState&&"loaded"!==a.readyState)},random:function(){return Math.floor(1E12*Math.random()).toString(36)},mixin:e,mergeDefaults:function(a,e,b){if(b){b={};for(var l in a)a.hasOwnProperty(l)&&(b[l]=a[l]);a=b}for(var d in e)d in a||(a[d]=e[d]);return a},preprocessParams:function(a){var e={},b;for(b in a)if(a.hasOwnProperty(b)){if("string"!==typeof a[b])try{e[b]=JSON.stringify(a[b])}catch(l){}else e[b]=
a[b];e[b]=encodeURIComponent(e[b])}return e},roundToIncrement:l(a(Math,Math.round)),floorToIncrement:l(a(Math,Math.floor)),inDom:function(a,e){for(e=e||window.document;a&&a!==e;)a=a.parentNode;return a===e},isWindowHttps:function(){return"https:"===window.location.protocol},dedupe:function(a){for(var e=a.length;e--;)a.indexOf(a[e])!==e&&a.splice(e,1)},inherit:function(a,b){function l(){}if("function"!==typeof a)throw Error("First argument must be function");if(!a.prototype)throw Error("First argument must have a prototype");
l.prototype=a.prototype;return e(new l,b)},all:function(a,e){if("function"!==typeof a||!d.$isArray(e))return!1;for(var b=!0,l=e.length-1;0<=l;l--)b=b&&a(e[l]);return b},lang:navigator.language||navigator.browserLanguage||navigator.userLanguage||navigator.systemLanguage}});
BSM.define("settings/config",["utils/objects"],function(g){function c(b,d){this._masterConfig=b;this._base=d||""}function f(b,c,a){var e;0>b.indexOf("/")?(e=a[b])&&"object"===typeof e&&!g.$isArray(e)?a[b]=d(c,e):a[b]=c:(b=b.split("/"),e=b.shift(),a[e]=a[e]||{},f(b.join("/"),c,a[e]));return a}function d(b,c){b=b||{};c=c||{};var a={},e,l,h,m,f;for(f in b)g.$isArray(b[f])?c[f]=b[f].slice():("object"===typeof b[f]&&b[f]&&null==c[f]&&(c[f]={}),a[f]="object"===typeof b[f]&&b[f]?d(b[f],c[f]):f in c?c[f]:
b[f]);for(f in c){e=a;l=f.split("/");for(m=l.pop();h=l.shift();)e=e[h]=e[h]||{};g.$isArray(c[f])||"object"!==typeof c[f]?e[m]=c[f]:"object"===typeof c[f]&&(e[m]=d(c[f],e[m]))}return a}function h(b){return"string"===typeof b?b:b?g.$isArray(b)?b.join("/"):"":""}c.DELIMITER="/";c.createRoot=function(b,h){var a=d(b,h);return new c(a)};c.explode=function(b,c){var a=c||{},e;for(e in b)f(e,b[e],a);return d(a,c)};c.prototype={_base:"",_masterConfig:null,get:function(b){var c=this._base,a=this._masterConfig;
b=h(b);for(c=(c+"/"+b).split("/");a&&c.length;)if(c[0]||c.shift())a="object"===typeof a&&c[0]in a?a[c.shift()]:null;c=c.length?null:a;return c&&"object"===typeof c?c.slice?c.slice(0):d(c):c},namespace:function(b){b=h(b);b=0===b.indexOf("/")?b:this._base+"/"+b;return new c(this._masterConfig,b)},set:function(b,d){for(var a=this._base,e=this._masterConfig,l=h(b),a=(a+"/"+l).split("/"),l=a.pop(),c;a.length;)if(c=a.shift())e[c]||(e[c]={}),e=e[c];e[l]=d;return this},defined:function(b){return null!==this.get(b)},
fork:function(b){return c.createRoot(this._masterConfig,b)},explode:c.explode};return c});
BSM.define("settings/default",["document"],function(g){function c(){if(g.currentScript)return g.currentScript;var d=g.getElementsByTagName("script"),c=d.length-1,b=/\/tags\/[bh]/,f,a=null;do if((f=d[c].src)&&(a=d[c]||a),f&&b.test(f))return d[c];while(c--);return a}var f=function(){var d=c().src,h=d.match(/https?:\/\/([^\/]+)/);if(!h)throw Error("cannot match domain from "+d);return h[1].replace(/^[^\.]+\./,"")}();return{debug:!1,version:"v2.0.27",auction:{default_bidder:"apn",data_bus:{},strategy:{phase:{strategy:{one:"parallel",
two:"parallel",three:"dutch"}}}},bid:{pricer:{gsp:{max_reduction_rate:1,soft_floor:100,sp_increment:10}},fetcher:{ortb:{price_multiplier:1E3,xd_url:"about:blank",bidder_url:"about:blank",is_cors:!1},criteo:{urlmaker:"urlmaker/criteo",var_name:"crtg_content",delay:100},yieldbot:{cache_key_loading:"cx/yieldbot/load",cache_key_loading_expire:36E5,cache_slot_prefix:"cx/yieldbot/slot",price_multiplier:10},xaxis:{postreadywait:200},oxm:{urlmaker:"urlmaker/oxm"},apn:{urlmaker:"urlmaker/apn"},decorators:{cache:{cache_prefix:"cx/bids"}},
pubmatic:{script_url:"http://ads.pubmatic.com/AdServer/js/gshowad.js",callback_name:"pubmatic_cb"},rubicon:{header_url:"//ads.rubiconproject.com/header/",bidder_code:"rubicon",namespace:"rubicontag",integration_code:"bs",size_map:{"728x90":2,"160x600":9,"300x600":10,"300x250":15,"320x50":43,"300x1050":54,"970x250":57}},casale:{index_args_namespace:"cygnus_index_args",response_namespace:"_IndexRequestData",response_cpm_key:"targetIDToBid",response_deal_key:"targetIDToDeal"},dfp:{pixel_key:"match|adx",
postreadywait:200},sonobi:{base_url:"https://apex.go.sonobi.com/trinity.js?key_maker=",creative_url:"//apex.go.sonobi.com/sbi.js"}},loaddfp:{gpt_ns:"googletag",gpt_url:"//www.googletagservices.com/tag/js/gpt.js"},invalid_expiration:0,expiration:3E4},controller:{nucleus:{gpt:{restore:{timeout:2E3},targeting:{ceiling:1E4,increments:250,targeting_prefix:"cxprices"}},updater:{prices_attribute:"data-bsm-prices",completed_attribute:"data-bsm-completed-slots"},rerun:{event_name:"rerunAuction"}},data_bus:{nucleus_notifier:{gpt_timeout:5E3}},
tracker:{revoke:{event_name:"offer.revoked",prefix:"cx/pbcap",event_key:"placement_id"},delivery:{event_name:"offer.displayed",prefix:"cx/dlcap",event_key:"placement_id"},"store-creative":{cache_key:"cx/history/displayed",expiry:864E6,max_entries:4}},self_update:{manifest_url:"//c."+f+"/u",idle_delay:1500}},eventlogger:{base_url:"//b."+f+"",delay:500},impression:{context:{strategy:"phase",floor:0,maxduration:5E3,soft_floor:0,use_cache:!0,increment:1.1,position:"unknown",section:"unkonwn",jsonprops:{sizes:1,
pub:1,cost:1,pageurl:1,slot:1,strategy:1,placement:1,shadow:1,synthetic:1,maxduration:1,hidden:1,id:1,sync:1}},displayer:{criteo:{baseUrl:"//cas.criteo.com/delivery/ajs.php"},yieldbot:{lib_url:"//cdn.yldbt.com/js/yieldbot.intent.js"},xaxis:{slot_ids:{"728x90":"Top1","300x250":"x15","160x600":"x10","300x600":"x16"}}}},model:{nucleus:{nucleus_tag:{attribute_prefix:"data-bsm-",default_attributes:{pub:"","pub-zone":"","soft-floor":0,position:"unknown",sizes:["728x90","300x250"],flag:"true","slot-list":"",
"platform-list":[]}}}},offer:{share:0,pricer:"first"},user:{session_key:"cx/session",session_exp_sec:18E5,uid_cache_key:"cx/user/id",cache:{urlEntry:{default_expire:36E5,default_stale:3E5}}},utils:{mercury:{msg_data_regex:"bsm.pixelEvent:",data_attribute_keys:["impression-id","platform-name","placement_id","price"],id_attribute_name:"data-impression-id",cx_id_prefix:"cx/"}},service:{bidfetcher:{max_offer_value:1E9}},zonemap:{enableCache:!1,expireTime:864E5,staleTime:36E5,cacheKey:"cx-zonemap"},flag:{enabled:!0,
bsm_namespace:"BSM",cache_prefix:"cx"},manifest:{bidderkeygen:{cache_prefix:"cx/bids/manifest"}},urlmaker:{type:null,apn:{member_id:1184,request_type:"fpt",secure_url:"https://secure.adnxs.com",url:"http://ib.adnxs.com"},apnh:{request_type:"jpt",secure_url:"https://secure.adnxs.com",url:"http://ib.adnxs.com"},brealtime:{url:"//optimizedby.brealtime.com"},criteo:{baseurl:"//cas.criteo.com/delivery/ajs.php",cookie_name:"crtg_rta"},oxm:{url:"//ox-d.cbs.servedbyopenx.com/w/1.0",request_type:"jstag",jstag_key:"oxm_pubId"},
mpm:{uripath:"bid/prm/js",hostname:"tags.mathtag.com",prm:0},openx:{request_type:"acj"}}}});BSM.define("config",["settings/config","settings/default"],function(g,c){var f=g.createRoot(c,window.bsm_tag&&window.bsm_tag.config||{});return window.BSM.config=f});
BSM.define("logger/messages",[],function(){return{RECEIVED_POST_MESSAGE:"received postMessage: %o",ONMESSAGE_FAILED:"onmessage failed: %o",SOLICITING_BID:'soliciting bid from "%s"',PHASE_ABORTED:"#abort(): phase aborted",PHASE_STARTING:"#start(): starting phase strategy, bidders = %o",PHASE_STARTED_NO_BIDDERS:"#startPhase(): %s/%s no bidders, ending phase",PHASE_STARRTED:"#startPhase(): #%s/%s, starting",PHASE_CLEARED:"#clearPhase() -- clearing phase %s/%s.",SENDING_BID_REQUEST:'#send() -- soliciting bid from "%s"',
BID_COLLECTED:'#collect() -- $%s bid from "%s/%s" for slot "%s" (%o: %o)',AUCTION_OPEN:"#open(): resource %o",TIMEOUT_NO_WINNER:"timeout! no winner, waiting %s",AUCTION_TIMEOUT:"exceeded maximum duration, declaring winner",OFFER_COLLECTED:"#collectOffer(): [%s] must: %s valid: %s",OFFER_CHECKED:"#check(): %s:$%s is %sclaimed",AUCTION_CLEARED:'#clearAuction() clearing slot "%s" "%s":$%s',AUCTION_CLOSED:"#close() sending notification, showing winner",AUCTION_REVOKED:"#onRevoked(): winning offer revoked",
AUCTION_IS_SYNC:".startAuction(): Sync auction for apn? %o",OFFER_CACHED:"new offer #%s (+%s stale): %o",FETCHING_CACHEABLE_BID:"%s of %s bids in cache, fetching %s/%s",REUSING_CACHED_BID:"%s cached bids available (%s needed), returning cached bid for %s/%s",CACHED_OFFER_RECEIVED:"cacheable bid of $%s from %s/%s received",BUILDING_GPT_SLOT:'building slot for "%s"',DFP_BIDDER_ABORT:"#abort(): received for request`%s`",DFP_ELEMENT_REMOVED:"removing element for slot %s",DFP_ON_RENDER_END:'render ended for slot "%s"',
DFP_HIDDEN_SLOT:'slot "%s" got empty response from dfp',DFP_ON_REVOKE:'slot "%s" revoked',DFP_ON_FRAME_READY:'Frame for slot "%s" is ready. Resolving in %dms',DFP_POST_READY_WAIT_COMPLETE:'post ready wait for slot "%s" complete, resolving',DFP_OFFER_REJECT:'rejecting offer from slot "%s"',DFP_REJECT_MESSAGE_RECEIVED:'rejection message from "%s"',XAXIS_OFFER_RESOLVED:"#sendValidOffer(), was fulfilled=%o",XAXIS_OFFER_REJECTED:"#sendRejectOffer(), was fulfilled=%o",BID_TIMEOUT:"timed out after %s ms, abort()ing",
FLUSH_RUN_QUEUE:"flushing existing run queue",MANIFEST_ENTRY_ADDED:"#add(): %s -> %o (expire=%o)",ABSTRACT_METHOD_ERROR:"method %s#%s() was not overridden",ERROR_RUNNING_COMMAND:"error running command: ",REVOKE_ERROR_GETTING_ID:"can not get impression id for revoked event: %o",BIDDER_KEYGEN_ARGUMENT_ERROR:"cannnot generate manifest key - received null platform / impression",BIDDER_KEYGEN_IMPRESSION_ERROR:"Can not generate manifest key - missing a required field: ",GPT_COMMAND_QUEUED:"Queued GPT command",
GPT_TARGETING_SET:"Set GPT targeting %s = %s",EVENT_RECEIVED:"Received event %s",GPT_PRICE_VALUES_UPDATED:"Update to GPT targeting value for slot key %s to %s",EVENT_LOGGER_SEND_EVENT:'Sending event "%s" with params %o',OFFER_CLAIMED:"offer %o is claimed ... re-running auction",REMOVE_MANIFEST:"removing manifest from placement id %s with key %o",AUCTIONING_SLOT_COUNT:"auctioning total of %d slots: %o",REQUESTING_NUCLEUS_URL:"sending json-p request for all slots using url %s",BID_REQUEST_REJECTED:'bidder %s rejected offer with error: "%s"',
NO_XHR_SUPPORT:"client lacks support for XMLHttpRequest",XHR_REQUEST_FAILED:"received non-200 status code from XHR request for url: ",PLATFORM_FILTERED:'filtering placement "%s:%s" since platform not in populated nucleus_tag#platform_list %o'}});
BSM.define("logger",["config","logger/messages"],function(g,c){function f(a){var e=window.console||{},b=e[a]||e.log;return b?Function.prototype.bind?Function.prototype.bind.call(b,e):function(){Function.prototype.apply.call(b,e,arguments)}:new Function}function d(a,e){this.logs=[];this.warns=[];this.errors=[];this.traces=[];this.prefix=a||"(unprefixed)";this.$output(e)}var h=["log","warn","trace","error"],b=(new Date).getTime(),k=function(){for(var a={},e=0;e<h.length;++e)a[h[e]]=f(h[e]);return a}();
d.prototype={logs:null,warns:null,errors:null,traces:null,prefix:"",$debug:!1,$output:function(a){null!=a&&(this.$debug=a);return this.$debug||g.get("debug")},track:function(a,e){if("log"===a)this.logs.push(e);else if("warn"===a)this.warns.push(e);else if("error"===a)this.errors.push(e);else if("trace"===a)this.traces.push(e);else throw"Unknown log action";},getPrefix:function(){var a=new Date-b,a=Math.floor(a/100)/10;return"+"+("+"+a+"s")+" "+this.prefix+": "},log:function(a){var e=Array.prototype.slice.call(arguments,
0);e[0]=[this.getPrefix(),e[0]].join("");this.track("log",e);this.$output()&&k.log.apply(null,e)},warn:function(a){var e=Array.prototype.slice.call(arguments,0);e[0]=[this.getPrefix(),e[0]].join("");this.track("warn",e);this.$output()&&k.warn.apply(null,arguments)},error:function(a){var e=Array.prototype.slice.call(arguments,0);e[0]=[this.getPrefix(),e[0]].join("");this.track("error",e);this.$output()&&k.error.apply(null,e)},trace:function(){var a=Array.prototype.slice.call(arguments,0);this.track("trace",
[Error().stack]);this.$output()&&k.trace.apply(null,a)}};d.messages=c;return d});BSM.define("utils/custom_dom_event",["module","window","document"],function(g,c,f){function d(d,b){var c=f.createEvent("CustomEvent");c.initCustomEvent(d,b.bubbles,b.cancelable,b.detail);return c}d.prototype=window.Event&&window.Event.prototype||{};return"function"==typeof c.Event?c.CustomEvent:d});
BSM.define("utils/msgs",["module","logger","utils","document","utils/custom_dom_event"],function(g,c,f,d,h){function b(a,b){a=m(a);var l=e(a);l.addEventListener?l.addEventListener("cx_custom_event",b,!0):l.attachEvent&&l.attachEvent("oncx_custom_event",b);return l}function k(a,b){a=m(a);var l=e(a);l.removeEventListener?l.removeEventListener("cx_custom_event",b,!0):l.detachEvent&&l.detachEvent("oncx_custom_event",b);return l}function a(a,b){"object"==typeof a&&"event_name"in a&&(b=a,a=b.event_name);
a=m(a);var l=new h("cx_custom_event",{detail:{data:b,cx_event_name:a},bubbles:!0,cancelable:!0});e(a).dispatchEvent(l)}function e(a){return n(a)||l(a)}function l(a){a=a.split(".");var e=a.slice(0,a.length-1).join("."),e=n(e)||l(e);a.unshift(r);a=a.join(".");return e.appendChild(p(a))}function p(a){var e=d.createElement("div");e.id=a;e.style.display="none";e.style.visibility="hidden";return e}function m(a){u(a)&&(a=a.join("."));return a||""}function n(a){if(!a)return q;a=[r,a].join(".");var e;try{e=
q.querySelectorAll('[id="'+a+'"]')}catch(b){return null}return e[0]}var r,t,q,u=f.$isArray;(function(){var a=d.getElementsByTagName("script")[0];new c(g.id);r=["cx",g.id].join("_").replace("/","_");q=t=d.createElement("div");q=l("root");var e=window.navigator.userAgent;!e.match(/phantom/i)&&!e.match(/safari/i)||e.match(/chrome/i)||a.parentNode.insertBefore(t,a);r=[r,"root"].join(".")})();return{listen:b,on:b,off:k,unlisten:k,fire:a,async:a}});
BSM.define("microdollar",[],function(){function g(c){if(c instanceof g)return c.clone();this._quantity=0;this.currency="usd";this.quantity(c)}g.prototype={_quantity:0,constructor:g,currency:"usd",quantity:function(c){if(null===c||void 0===c)return this._quantity;c=c instanceof g?c.quantity():parseInt(c,10);if(isNaN(c))throw new TypeError("amount must be an integer");return this._quantity=c},getCPM:function(){return Math.ceil(this.quantity()/10)/100},gt:function(c){return this.quantity()>c.quantity()},
gte:function(c){return this.quantity()>=c.quantity()},multiplyBy:function(c){c=parseFloat(c);if(!c||1===c)return this;this.quantity(Math.round(this._quantity*c));return this},clone:function(){var c=new this.constructor(this._quantity);c.currency=this.currency;return c},toJSON:function(){return this._quantity}};return g});BSM.define("impression/positionmap",[],function(){return{above:1,1:"above",below:3,3:"below",unknown:0,0:"unknown"}});
BSM.define("impression/context","config module microdollar ./positionmap utils window document".split(" "),function(g,c,f,d,h,b,k){function a(a){a=a||{};this.sizes=["1x1"];this.biases={};this.soft_floor=e.get("soft_floor");this.maxduration=e.get("maxduration");for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);"string"===typeof this.container&&(this.container=k.getElementById(this.container));this.id=this.container&&this.container.id||this.id||"cx/"+Math.floor(1E12*Math.random()).toString(36);this.size=
this.sizes[0]||"";this.site=(this.pub_zone||"").split("/")[0];this.pos=this.position;this.positionIndex=this.pos in d?d[this.pos]:0;this.placement||(this.placement=this.pub+":"+this.pub_zone+"#"+this.slot);this.setKeyWords(a.kv);this.setXYOffset();this.strategy=this.isFirstLook()?"parallel":this.strategy;this.setPageUrl()}var e=g.namespace(c.id);g=encodeURIComponent(function(){var a=b.top,e;try{e=a.location.href}catch(d){e=k.referrer||b.location.href}return e}());a.prototype={slotId:"",flag:!1,firstLook:!1,
id:null,cacheKey:"",use_cache:e.get("use_cache"),sizes:["1x1"],size:"",pos:e.get("position"),position:e.get("position"),slot:"",strategy:e.get("strategy"),pageurl:g,container:null,dfp:null,ixp:null,apn:null,apnplacement:null,zone_map_url:"",shadow:!1,debug:!1,kv:{},pub_zone:"",maxduration:0,increment:e.get("increment"),floor:e.get("floor"),soft_floor:e.get("soft_floor"),biases:null,bidders:[],reserve:0,bcat:null,badv:null,battr:null,kw:null,hidden:!1,sync:!1,event_host:"",pub:"",rurl:"",placement:"",
session:{},geo:"",getSlotId:function(){return this.slotId?this.slotId:this.slotId=this.placement?this.placement.replace(/[:#]/g,"/"):["cx",this.pub_zone,Math.floor(1E6*Math.random())].join("/")},toJSON:function(){var a={},b=e.get("jsonprops"),d;for(d in this)d in b&&(a[d]=this[d]);a.id=this.id;return a},getSlotKey:function(){this.cacheKey||(this.cacheKey=this.pub_zone+"@"+this.size+"#"+this.position);return this.cacheKey},isFirstLook:function(){return!(!this.firstLook&&!this.flag)},useCache:function(){return this.isFirstLook()||
this.use_cache},getSection:function(){return(this.pub_zone||"").split("/")[1]||e.get("section")},getSoftFloor:function(){this._soft_floor||(this._soft_floor=new f(this.soft_floor||0));return this._soft_floor},getFloor:function(){this._floor||(this._floor=new f(this.floor||0));return this._floor},getReserve:function(){var a=this.getFloor().quantity(),e=this.getSoftFloor().quantity();this._reserve||(this._reserve=new f(Math.max(a,e)));return this._reserve},setKeyWords:function(a){a=a||{};var e={};e.imp=
this.id;for(var b in a)a.hasOwnProperty(b)&&(e[b]=a[b]);return this.kv=e},setXYOffset:function(){var a=this.container;if(a)for(;a;)this.x+=a.offsetLeft-a.scrollLeft+a.clientLeft,this.y+=a.offsetTop-a.scrollTop+a.clientTop,a=a.offsetParent},x:0,y:0,setPageUrl:function(){var a=decodeURIComponent(this.pageurl),e=a.indexOf("?");0<=e&&(a=a.substr(0,e));return this.pageurl=encodeURIComponent(a)}};return a});
BSM.define("impression",["microdollar","impression/context"],function(g,c){function f(d){d=d||{};this.context=d=d instanceof c?d:new c(d);this.reserve=d.getReserve()}f.prototype={context:null,reserve:null,name:function(){return[this.context.placement,this.context.size].join("@")},toString:function(){return["Impression: ",this.context.placement,"@",this.context.sizes.join(",")].join("")},toJSON:function(){return this.context.toJSON()}};return f});
BSM.define("user/cache/entry",["require","when"],function(g){function c(b,d,a,e){this.key=b;this.lockOwner=!1;this.reader=function(){var a=d(b);a&&a.cacheEntry||(a={cacheEntry:!0,value:null!=a?a:null});a.expire=(new Date(a.expire||Number(new Date)-864E5)).getTime();a.stale=(new Date(a.stale||Number(new Date)-864E5)).getTime();a.lock&&(a.lock.expire=new Date(a.lock.expire||0));return a};this.writer=function(e){a(b,e)};this.remover=function(){e(b)};this.raw=this.reader()}function f(b){return!(b&&"DANGERZONE"===
b.state&&b.expire>Number(new Date))}function d(b){return b&&b.expire>Number(new Date)&&("DANGERZONE"===b.state||"DUMPTRUCK"===b.state)}var h=g("when");c.prototype.value=function(b){var c=this.reader();if("undefined"===typeof b){if(!f(c.lock)&&!this.lockOwner)throw Error("Entry is locked");this.raw=c;return this.checkExpiration()}if(d(c.lock)&&!this.lockOwner)throw Error("Entry is locked");this.raw.value=b;return this};c.prototype.valueAnd=function(b){var c=h.defer(),a=this,e=a.reader(),l;"undefined"!==
typeof b?d(e.lock)?c.reject("Entry is locked"):(a.raw.value=b,c.resolve(b)):f(e.lock)?(a.raw=e,c.resolve(a.checkExpiration())):l=setInterval(function(){e=a.reader();if(f(e.lock)){a.raw=e;var b=a.checkExpiration();c.resolve(b);clearInterval(l)}},50);return c.promise};c.prototype.expire=function(b){b=Number(b);return isNaN(b)?!(this.raw.expire>Number(new Date)):(this.raw.expire=(new Date((new Date).getTime()+b)).getTime(),this)};c.prototype.stale=function(b){b=Number(b);if(isNaN(b))return!(this.raw.stale>
Number(new Date));this.raw.stale=(new Date((new Date).getTime()+b)).getTime();return this};c.prototype.lock=function(){return this.setLockTo("DANGERZONE")};c.prototype.lockPartial=function(){return this.setLockTo("DUMPTRUCK")};c.prototype.setLockTo=function(b){function c(){var a=e.reader();delete a.lock;e.writer(a)}var a=this.reader(),e=this;if(d(a.lock))return!1;this.raw.lock=a.lock={state:b,expire:new Date(Number(new Date)+5E3)};window.addEventListener?window.addEventListener("unload",c):window.attachEvent?
window.attachEvent("onbeforeunload",c):window.onbeforeunload=c;this.lockOwner=!0;this.writer(a);return!0};c.prototype.lockAnd=function(){var b=this.reader();if(d(b.lock))return h.reject(this.value());this.raw=b;this.lock();return h.resolve(b.value)};c.prototype.save=function(){this.writer(this.raw);return this};c.prototype.release=function(){delete this.raw.lock;this.lockOwner=!1;return this.save()};c.prototype.remove=function(){this.remover();return null};c.prototype.checkExpiration=function(){if(this.expire())this.remove(),
this.raw=this.reader();else return this.raw.value};return c});BSM.define("user/cache",["require","utils/localstorage","./cache/entry"],function(g){function c(a){return new k(a||"",f,d,h)}function f(a){a=b?b[a]:null;try{a=JSON.parse(a)}catch(e){a=null}return a}function d(a,e){var c;try{c=JSON.stringify(e)}catch(d){return}b&&(b[a]=c)}function h(a){b&&b.removeItem(a)}var b=g("utils/localstorage"),k=g("./cache/entry");c.DELIMITER="/";return c});
BSM.define("utils/sessionstorage",["window"],function(g){var c;try{var f="sessionStorage"in g&&null!==g.sessionStorage&&g.sessionStorage,d;f.setItem("cx-lscheck","test");d=f.getItem("cx-lscheck");f.removeItem("cx-lscheck");c="test"===d?f:!1}catch(h){c=!1}return c});
BSM.define("user/session",["config","utils/sessionstorage","user/cache","utils"],function(g,c,f,d){function h(){var a={},b;c?(b=c.getItem("pv"))&&(a.pv=b):a.pv=-1;return a}function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}g=g.namespace("user");var k=g.get("session_key")||"cx/session",a=g.get("session_exp_sec")||18E5;return{getValue:function(){var a=f(k),a=a.expire()?"":a.value();a||(a={},a.id=""+(new Date).getTime()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b(),a.pv=0,a.sc=
0,a.ac=0,this.save(a));return a},save:function(e){var b=f(k);b.value(e);b.expire(a);b.save()},incPageViewCount:function(){var a=h().pv;void 0===a&&(a=this.inc("pv"),c&&c.setItem("pv",a.pv));return a},incStartCount:function(a){this.incPageViewCount();var b=this.inc("sc");this.saveToCtx(a);return b},incAuctionCount:function(a){var b=this.inc("ac");this.saveToCtx(a);return b},saveToCtx:function(a){if(a){var b=this.getValue(),c=h();a.session=d.mixin(b,c)}},inc:function(a){var b=this.getValue(),c=b[a],
c=Number(c),c=isNaN(c)?1:c+1;b[a]=c;this.save(b);return b}}});
BSM.define("user/pageview",[],function(){function g(){var a=(new Date).getTime(),e={};window.BSM=window.BSM||{};window.BSM.pageview_id=a;(function(){function a(b){b=b||window.event;var c=b.data,d,l;try{l=JSON.parse(c),d=l.type}catch(h){return h}if(d&&e[d])e[d](l,b.source,b.origin)}window.addEventListener?window.addEventListener("message",a,!1):window.attachEvent&&window.attachEvent("onmessage",a)})();e.request=f;e.response=d;b({type:"request",at:c()})}function c(){return window.BSM.pageview_id}function f(a,
e,b){h(e,{type:"response",at:c()})}function d(a,e,b){a=a.at;c()>a&&(window.BSM.pageview_id=a)}function h(a,e,b){b=b||"*";var c;try{c=JSON.stringify(e)}catch(d){return}a&&a.postMessage&&a.postMessage(c,b)}function b(a){var e=window;for(k(e,a);e.parent!=e;)e=e.parent,h(e,a),k(e,a)}function k(a,e){try{for(var b=a.document.getElementsByTagName("iframe"),c=b.length-1;0<=c;c--)h(b[c].contentWindow,e)}catch(d){}}window.BSM&&window.BSM.pageview_id||(window.BSM=window.BSM||{},g());return c});
BSM.define("user",["config","user/cache","user/session","user/pageview"],function(g,c,f,d){var h=g.namespace("user").get("uid_cache_key"),b=c(h).value();return{geoData:{},initialize:function(b){this.getId();b&&b.geo&&(this.geoData=b.geo)},getId:function(){b||(b=this.getSessionId(),c(h).value(b).expire(1E12).save());return b},getPartnerId:function(b){return""},getIp:function(){return this.geoData.ip||"192.168.1.1"},getCountry:function(){return this.geoData.country||"US"},getRegion:function(){return this.geoData.region||
"SF"},getSessionId:function(){return f.getValue().id},getPageViewId:function(){return d()}}});
BSM.define("eventlogger","module config logger utils utils/objects user document".split(" "),function(g,c,f,d,h,b,k){function a(a){var e={};e.s=a.id;e.s_sc=a.sc;e.s_ac=a.ac;e.s_pv=a.pv;return e}function e(){this.onload=this.onreadystatechange=null}var l=["mbid","event"],p=new f(g.id),m=c.namespace(g.id).get("base_url"),n=c.get("version");return function(c,g,q,u){u={};var v=g.session;u.u=b.getId();u.pv_id=b.getPageViewId();h.$isObject(v)&&(u=d.mixin(u,a(v)),delete g.session);g.user=u;g.v=n;p.log(f.messages.EVENT_LOGGER_SEND_EVENT,
c,g);q=q||m;g=d.toQuery(d.preprocessParams(g));g=[q,c].join("/")+"?"+g;q=k.createElement("iframe");q.onload=q.onreadystatehange=e;q.src=g;q.id=l.concat([c,d.random()]).join("/");q.style.display="none";c=k.getElementsByTagName("script");c=c[c.length-1];c.parentNode.insertBefore(q,c)}});
BSM.define("auction/databus/send/revoke",["eventlogger"],function(g){return function(c){var f=c.winner,d=c.resource,h=d.context;c={offer:f,impression:d,placement_id:f.offeredBy.get("placement_id"),price:~Math.max(0,c.clearedPrice.quantity()),session:h.session};g("revoked",c,h.event_host,h.id,!0)}});
BSM.define("auction/databus/send/cleared",["eventlogger","window"],function(g,c){return function(f){var d=f.resource,h=d.context,b=f.winner;f={duration:f.duration,winner:b.offeredBy.platform,placement_id:b.offeredBy.get("placement_id"),impression:d,price:f.clearedPrice.quantity(),flag:h.flag?h.flag:!1,session:h.session};h.flag&&(f.nucleusVersion=c.BSM.nucleusVersion);g("cleared",f,h.event_host,h.id)}});
BSM.define("auction/databus/send/error",["eventlogger"],function(g){return function(c){var f=c.resource,d=f.context,h=c.bidSelector.offers.slice(0),b=c.error;g("error",{offers:h,duration:c.duration,impression:f,flag:d.flag?d.flag:!1,session:d.session,error:{name:b.name,message:b.message,stack:b.stack?b.stack.toString():""}},d.event_host,d.id,!0)}});BSM.define("auction/databus/send/filled",["eventlogger"],function(g){return function(c){var f=c.impression;g("filled",c,f.event_host,f.id)}});
BSM.define("auction/databus/send/passback",["eventlogger"],function(g){return function(c){var f=c.resource,d=f.context,h=d.getFloor();g("passback",{impression:f,floor:h,duration:c.duration,session:d.session},d.event_host,d.id)}});BSM.define("auction/databus/sendevent","./send/revoke ./send/cleared ./send/error ./send/filled ./send/passback user/session".split(" "),function(g,c,f,d,h,b){var k={cleared:c,revoked:g,error:f,filled:d,passback:h};return function(a,e){e.session=e.session||b;if(a in k)k[a](e)}});
BSM.define("bid/pricer",["module","config","microdollar"],function(g,c,f){function d(b,c,a){"number"===typeof b||b instanceof f||(b=h.get("soft_floor"));this.softFloor=new f(b);this.maxReductionRate=c||h.get("max_reduction_rate");this.increment=a||h.get("sp_increment")}var h=c.namespace("bid/pricer/gsp");d.prototype={get:function(b,c){var a=b.getPricingType();if("first"===a)return this.first(b);if("gsp"===a)return this.gsp(b,c);throw"Unknown price type";},first:function(b){return b.getPrice()},gsp:function(b,
c){var a=this.softFloor.clone(),e=this.increment,d=c?c.getPrice():new f(0),h=b.getPrice();a.gt(d)&&(d=a);a=d.quantity()+e;a<=h.quantity()&&d.quantity(a);d.gt(h)&&(d=h);return d}};return d});
BSM.define("bid/ranker",["bid/pricer","microdollar"],function(g,c){function f(d){if(!d.length)return[];for(var b=d[0],f=b.getPrice(),a=new c(0),e=null,l=!1,g,m,n,r,t,q=0,u=d.length;q<u;++q)g=d[q],m=g.getPrice(),r=(n=g.isValid())&&g.mustFill(),t=n&&(r||m.gt(f)),!l&&t&&(f.gt(a)&&(a=f,e=b),f=m,b=g,l=r),!t&&n&&m.gt(a)&&(a=m,e=g);return[e,b]}function d(c){this.pricer=c||new g;this._topOffers=[];this._allOffers=[]}d.prototype={_topOffers:null,_allOffers:null,pricer:null,rank:function(c){this._allOffers.push(c)},
_rank:function(){this._topOffers=f(this._allOffers).slice(0)},getFirst:function(){this._rank();return this._topOffers[this._topOffers.length-1]},getSecond:function(){this._rank();return this._topOffers[this._topOffers.length-2]},getSecondByOffer:function(c){var b=[],d=0,a=this._allOffers.length,e;if(c&&c.isValid()){for(;d<a;d++)e=this._allOffers[d],c.getPrice().gte(e.getPrice())&&b.push(e);c=f(b);return c[c.length-2]}}};return d});
BSM.define("offer/displayer",[],function(){function g(){}g.prototype={promise:null,type:"super",iframe:null,display:function(c,f,d,h){var b=this,g=f.container;f=this._getOptions(f,g.id,d,h);this.promise||(this.promise=this._getFrame(c,g,f),this.promise.then(function(a){b.iframe=a}));return this.promise},remove:function(c){var f=c.container,d=this;this.iframe?f.removeChild(this.iframe):this.promise.then(function(){f.removeChild(d.iframe)})},_getOptions:function(c,f,d,h){c=c.size.split("x");var b=["cx_frame",
c[0],c[1],f].join("/");return{width:c[0],height:c[1],name:b,id:b,"data-impression-id":f,"data-placement_id":d,"data-price":h}},_getFrame:function(c,f,d){throw"Implement me";}};return g});
BSM.define("utils/friendlyiframe",["when","utils"],function(g,c){function f(a,e){var b,d;for(d in e)e.hasOwnProperty(d)&&(b=e[d],"style"!==d?(a.setAttribute(d,b),a[d]=b):"style"===d&&"object"===typeof b&&a.style&&(a.style.cssText=c.$toString(b,":","; ")))}function d(a,e){h();var b=h();b&&11>=b?(b=a.contentWindow,b.content=e,b.location.replace("javascript:window.content")):(b=a.contentWindow.document,b.open("text/html","replace"),b.write(e),b.close())}function h(){return document.documentMode?parseInt(document.documentMode,
10):!1}var b=["<!doctype html><html><head></head><body>","<script>window.inDapIf=true;\x3c/script>","",null,"</body></html>"],k=h()?"javascript:":"javascript:\"<html><body style='background:transparent'></body></html>\"",a=0,e={frameBorder:0,vSpace:0,hSpace:0,marginHeight:0,marginWidth:0,scrolling:"no"};return function(l,h,m){++a;var n=document.createElement("iframe");m=c.mergeDefaults(m,e);var r=m.name||m.id||["bsm/fif",Math.floor(1E12*Math.random())].join("/"),t=b.slice(0),q=g.defer(),u=q.resolver,
v=!(0<=navigator.userAgent.indexOf("AppleWebKit")),w=m.onload;t[3]=l;delete m.onload;m.name=m.name||r;m.id=m.id||m.name;f(n,m);h.appendChild(n);n.onload=n.onreadystatechange=function(){try{if(!c.inDom(this,this.ownerDocument))return u.reject(Error("invalid dom state"))}catch(a){}if(c.$isReady(this)){if(v)return this.onload=this.onreadystatechange=null,u.resolve(this);v=!0}};n.src=k;try{d(n,t.join("")),"function"===typeof w&&w(n)}catch(x){return q.reject(x)}return q.promise}});
BSM.define("offer/displayer/friendly",["utils","offer/displayer","utils/friendlyiframe"],function(g,c,f){function d(){c.apply(this,arguments)}d.prototype=g.inherit(c,{type:"friendly",_getFrame:function(c,b,d){return f(c,b,d)}});return d});
BSM.define("utils/remote_iframe",["document","utils","when"],function(g,c,f){function d(b,c){var a=g.createElement(b),e;for(e in c)c.hasOwnProperty(e)&&a.setAttribute(e,c[e]);return a}function h(b){return c.isWindowHttps()&&0===b.indexOf("http://")?b.substr(5):b}return function(b,g,a){b=h(b);var e=f.defer();a=c.mergeDefaults({frameBorder:0,vSpace:0,hSpace:0,marginHeight:0,marginWidth:0,scrolling:"no",allowtransparency:"true",style:"border:0px;margin:0px;padding:0px"},a);var l=d("iframe",a);l.onload=
l.onreadystatechange=function(){c.$isReady(this)&&e.resolver.resolve(l)};l.onerror=e.resolver.reject;g.appendChild(l);l.setAttribute("src",b);return e.promise}});BSM.define("offer/displayer/remote",["utils","offer/displayer","utils/remote_iframe"],function(g,c,f){function d(){c.apply(this,arguments)}d.prototype=g.inherit(c,{type:"remote",_getFrame:function(c,b,d){return f(c,b,d)}});return d});
BSM.define("offer/displayer/noop",["utils","when","offer/displayer"],function(g,c,f){function d(){f.apply(this,arguments)}d.prototype=g.inherit(f,{type:"noop",display:function(){return c.defer().promise},_getFrame:function(){return c.defer().promise},remove:function(){}});return d});
BSM.define("offer/displayer/create",["offer/displayer/friendly","offer/displayer/remote","offer/displayer/noop"],function(g,c,f){return function(d){return d&&"string"===typeof d?"http"===d.slice(0,4)||"//"===d.slice(0,2)?new c:new g:new f}});
BSM.define("model/event",["utils/msgs"],function(g){function c(c){if(c){var f=this.constructor.prototype,b;for(b in f)c.hasOwnProperty(b)&&(this[b]=c[b])}}function f(c){g.listen(this.prototype.event_name,c);return this}c.extend=function(d,h){function b(a){return this.$super.call(this,a)}"object"==typeof d&&(h=d,d=b);d.prototype=new c;d.prototype.constructor=d;d.prototype.$super=c;d.on=f;for(var g in h)h.hasOwnProperty(g)&&(d.prototype[g]=h[g]);return d};c.prototype.fire=function(){var c=this.event_name,
f=this.fire;"event_key"in this&&this.event_key&&(c=[c,this.event_key]);delete this.fire;g.fire(c,this);this.fire=f;return this};return c});BSM.define("model/event/offer/displayed",["model/event"],function(g){return g.extend({event_name:"offer.displayed",event_key:"",bidder:null,display_type:null,impression:null,offer:null,placement_id:0,price:0,duration:0,context:{}})});
BSM.define("offer","module config microdollar when user/cache offer/displayer/create utils model/event/offer/displayed".split(" "),function(g,c,f,d,h,b,k,a){function e(a,e,c,d,l,g){if(!arguments.length)return this;this.offeredBy=d;this.timestamp=(new Date).getTime();this.context=e;this.askResource=c;this.displayer=l||e.displayer||b(e.adurl);this.duration=d&&d.duration||0;this.resource=a;this.resource.multiplyBy(this.offeredBy.get("bias"));this.setPrice(a,g);this.reserve=c&&c.reserve&&c.reserve.clone()||
new f(0);if(this.key=e.key||"")this.cacheEntry=h(this.key)}function l(a,e){if(!e)return e;var b=a.gross,b={"${AUCTION_AD_ID}":a.context.adid||"","${AUCTION_PRICE}":b.getCPM(),"${AUCTION_CURRENCY}":b.currency},c;for(c in b)b.hasOwnProperty(c)&&(e=e.replace(c,b[c]));return e}e.prototype={context:null,bindTo:k.$bindTo,key:"",cacheEntry:null,claimed:!1,displayer:null,metadata:null,timestamp:0,revoked:!1,gross:null,net:null,resource:null,askResource:null,offeredBy:null,duration:0,reserve:null,passback:!1,
isValid:function(){return this.resource&&this.resource.gte(this.offeredBy.floor())&&!this.revoked&&!this.claimed},mustFill:function(){return this.offeredBy.get("must_fill")},getCPM:function(){return this.net.getCPM()},toJSON:function(){var a={};a.by=this.getPlatform();a.bias=this.offeredBy.bias;a.val=this.net;a.res=this.reserve;a.valid=this.isValid();a.duration=this.duration;return a},setPrice:function(a,e){var b=parseFloat(this.offeredBy.get("share"))||0;e?this.calculateGross(a,b):this.calculateNet(a,
b);this.resource=this.net;return this},revoke:function(){this.net.quantity(-1E3);this.revoked=!0;this.displayer&&this.displayer.remove(this.askResource.context);this.context.rurl&&((new Image).src=this.context.rurl)},calculateNet:function(a,e){this.gross=a.clone();this.net=a.clone().multiplyBy(1-e)},calculateGross:function(a,e){this.net=a.clone();this.gross=a.clone().multiplyBy(1/(1-e))},getPlatform:function(){return this.offeredBy.platform||""},getGrossPrice:function(){return this.gross.clone()},
getPrice:function(){return this.net.clone()},hasBid:function(){return!!this.net},isClaimed:function(){var a;!(a=this.claimed)&&(a=!!this.cacheEntry)&&(a=this.cacheEntry,a=!(a.value()&&!a.expire()));return this.claimed=a},claim:function(){if(this.claimed)return!1;this.cacheEntry&&this.cacheEntry.remove();return this.claimed=!0},getPricingType:function(){return this.offeredBy.get("pricing_type")},canDisplay:function(){return!!this.context.adurl},display:function(){var a=this.offeredBy.get("placement_id"),
e=this.getPrice().quantity(),b=l(this,this.context.adurl),c=this.askResource.context;if(!this.displayer)return d.reject("Offer has no displayer");this.startDisplayTime=new Date;return this.displayer.display(b,c,a,e).then(this.bindTo(this.fireDisplayedEvent))},fireDisplayedEvent:function(){var e=new Date-this.startDisplayTime;(new a({event_key:this.askResource.context.getSlotKey(),display_type:this.displayer.type,offer:this,impression:this.askResource.context,bidder:this.offeredBy,placement_id:this.offeredBy.get("placement_id"),
platform_name:this.offeredBy.get("platform"),price:this.getPrice().quantity(),duration:e,context:this.context})).fire()},getNotifyUrl:function(){return l(this,this.context.nurl)}};return e});
BSM.define("model/model",["utils"],function(g){function c(){}function f(c){var h=this,b=function(){return h.apply(this,arguments)};"object"===typeof c?b.prototype=g.inherit(this,c):c.prototype&&c.constructor&&(c.prototype=g.inherit(this,c.prototype),b=c);b.extend=f;return b}c.prototype={get:function(c){return this[c]},set:function(c,f){this[c]=f;return this[c]}};c.extend=f;return c});
BSM.define("utils/spec",[],function(){function g(c,b){this.one=c;this.other=b}function c(c,b){this.one=c;this.other=b}function f(c){this.one=c}var d={and:function(c){return new g(this,c)},or:function(d){return new c(this,d)},not:function(c){return new f(this,c)},isSatisfiedBy:function(c){throw"Implement me";}};g.prototype=Object.create(d);g.prototype.isSatisfiedBy=function(c){return this.one.isSatisfiedBy(c)&&this.other.isSatisfiedBy(c)};c.prototype=Object.create(d);c.prototype.isSatisfiedBy=function(c){return this.one.isSatisfiedBy(c)||
this.other.isSatisfiedBy(c)};f.prototype=Object.create(d);f.prototype.isSatisfiedBy=function(c){return!this.one.isSatisfiedBy(c)};return d});
BSM.define("bidder/specs",["utils/spec"],function(g){function c(b){this.limit=b}function f(b){this.count=b}function d(b){this.duration=b}function h(){}c.prototype=Object.create(g);c.prototype.isSatisfiedBy=function(b){b=b.invalid_count;return"number"===typeof b&&b>=this.limit};f.prototype=Object.create(g);f.prototype.isSatisfiedBy=function(b){b=b.invalid_skip_count;return"number"===typeof b&&b<this.count};d.prototype=Object.create(g);d.prototype.isSatisfiedBy=function(b){b=b.last_collected_at;var c=
(new Date(b)).getTime()+this.duration,a=(new Date).getTime();return!("number"===typeof b&&c>a)};h.prototype=Object.create(g);h.prototype.isSatisfiedBy=function(b){var c=!0;b.forEach(function(a){var e=a.shift();c=c&&e.isCapped.apply(e,a)});return c};return{OverInvalidCountSpec:c,InvalidSkipsRemainingSpec:f,InvalidPenaltyExpiredSpec:d,TrackersCapacityReachedSpec:h}});
BSM.define("utils/freqtracker",["user/cache"],function(g){function c(c){var h=g(c).value()||[];this.key=c;f(c,h)}function f(c,f){var b=g(c);b.value(f);b.expire(6048E5);b.stale(6048E5);b.save()}c.prototype={key:null,limit:null,period:null,getCount:function(c){if(!c)return 0;var f=g(this.key).value()||[],b=new Date,k=new Date(b.getTime());k.setDate(k.getDate()+1);k.setHours(0,0,0,0);do k.setHours(k.getHours()-c);while(b<k);k<b?k=new Date(b.setHours(b.getHours()-c)):k.setHours(k.getHours()-c);c=k;f=
f.slice(0);for(b=f.length;b--&&!((new Date(f[b])).getTime()<c.getTime()););return f.slice(b+1).length},tick:function(){var c=g(this.key).value()||[];c.push((new Date).getTime());f(this.key,c)},isCapped:function(c,f){return this.getCount(c)>=f}};return c});
BSM.define("bidder/manifest","module config utils utils/msgs user/cache bidder/specs utils/freqtracker".split(" "),function(g,c,f,d,h,b,k){function a(a,e,b){this.model=a;if(this.platform=e)this.setupTrackers(b),this.setupSpecs(a)}function e(a){return[p,"/",a.pub,":",a.site,"@",a.size,"#",a.position].join("")}var l=c.namespace("manifest/bidder"),p=l.get("cache_key");a.prototype={model:null,platform:null,inPenalty:null,penaltyExpired:null,deliveryTracker:null,passbackTracker:null,bindTo:f.$bindTo,shouldFetch:function(a){if(!this.inPenalty||
this.model.get("default"))return!0;a=e(a);a=this.getBySlot(a);var b=this.model.get("delivery_cap"),c=this.model.get("passback_cap"),b=[[this.deliveryTracker,b.period,b.interval],[this.passbackTracker,c.period,c.interval]];return this.inPenalty.not().isSatisfiedBy(a)&&this.canDeliver.isSatisfiedBy(b)},logOffer:function(a,b){var c=e(a),c=this.getBySlot(c),d=this.updateManifest(c,b);this.saveManifest(a,c);return d},getBySlot:function(a){return(a=h(a).value())&&"object"===typeof a&&a[this.platform]||
{}},setupSpecs:function(a){var e=a.get("invalid_cap");a=new b.OverInvalidCountSpec(e.limit);var c=new b.InvalidPenaltyExpiredSpec(e.period),d=new b.InvalidSkipsRemainingSpec(e.skips),e=new b.TrackersCapacityReachedSpec,l=c.or(d.not());a=a.and(c.not().or(d));this.penaltyExpired=l;this.inPenalty=a;this.canDeliver=e.not();return this},setupTrackers:function(a){this.deliveryTracker=this.getTracker("delivery");this.passbackTracker=this.getTracker("passback")},getTracker:function(a){a=c.namespace("controller/tracker/"+
a);a=[a.get("prefix"),this.model.get(a.get("event_key"))].join("/");return new k(a)},updateManifest:function(a,e){function b(e){a[e]=(a[e]||0)+1}function c(){a.invalid_count=a.invalid_skip_count=0}var d=(new Date).getTime(),l=e.isValid();this.inPenalty.isSatisfiedBy(a)&&!l?(b("invalid_skip_count"),this.penaltyExpired.isSatisfiedBy(a)&&c()):(a.last_collected_at=d,l?c():b("invalid_count"));return a},saveManifest:function(a,b){var c=e(a),d=l.get("expiry"),f=h(c),g=f.value()||{};g[this.platform]=b;f=
h(c);f.value(g);f.expire(d);f.stale(d);f.save()}};return a});
(function(g){BSM.define("when/timeout",["require","./when"],function(c){var f,d,h,b;f=c("./when");try{b=c("vertx"),d=function(a,e){return b.setTimer(e,a)},h=b.cancelTimer}catch(g){d=setTimeout,h=clearTimeout}return function(a,e){if("number"===typeof e){var b=e;e=a;a=b}return f.promise(function(b,c,l){var g=d(function(){c(Error("timed out after "+a+"ms"))},a);f(e,function(a){h(g);b(a)},function(a){h(g);c(a)},l)})}})})("function"===typeof BSM.define&&BSM.define.amd?BSM.define:function(g){module.exports=
g(require)});BSM.define("manifest/bidderkeygen",["module","config","logger/messages"],function(g,c,f){var d=c.namespace(g.id).get("cache_prefix");return function(c,b){if(!c||!b)throw Error(f.BIDDER_KEYGEN_ARGUMENT_ERROR);var g=b.size||"",a=b.pub,e=b.site,l=b.position;if(!g||!a||!e)throw Error(f.BIDDER_KEYGEN_IMPRESSION_ERROR+[c,g,a,e].join("/"));g=[d,c,g,a,e];a=[g.join("/")];"unknown"!=l&&(g.push(l),a.unshift(g.join("/")));return a}});
BSM.define("manifest/manifest","logger utils utils/objects when user/cache logger/messages".split(" "),function(g,c,f,d,h,b){function k(a,e){var b=c.$isArray(a)?a.slice(0):[a];this._logger=new g("Manifest["+b[0]+"]");this._userCacheKey=b.shift();this._manifestCacheEntry=h(this._userCacheKey);this._expires=e;this._setSubkeys(b)}k.prototype={_defer:null,_expires:0,_logger:null,_subManifests:null,_subManifestKeys:null,_timer:0,_userCacheKey:"",bindTo:c.$bindTo,_setSubkeys:function(a){for(var b=this._userCacheKey,
c;0<=(c=a.indexOf(b));)a.splice(c,1);this._subManifestKeys=a},_getSubManifests:function(){this._subManifests||(this._subManifests=this._createSubManifests());return this._subManifests},_createSubManifests:function(){var a=this._subManifestKeys,b=[];if(a&&a.length)for(var c=0,d=a.length;c<d;++c)b.push(new k(a[c]));return b},_getSubManifestKeys:function(){for(var a=this._getSubManifests(),b=[],c,d=0,f=a.length;d<f;++d){c=a[d]._keys();for(var g=0,h=c.length;g<h;++g)0>b.indexOf(c[g])&&b.push(c[g])}return b},
_getOwnKeys:function(){return this._manifestCacheEntry.value()||[]},add:function(a,b,c){this._getOwnKeys();c=0<=c?c:this._expires;var d=h(a);d.value(b);d.expire(c);d.save();this._cleanupAfterWait(b);return this.addKey(a)},addKey:function(a){var b=this._getOwnKeys(),c=h(this._userCacheKey),d=0>b.indexOf(a);d&&(b.push(a),c.value(b));c.expire(31536E6);c.stale(31536E6);c.save();return d},_cleanupAfterWait:function(a){this._defer&&(this._defer.resolver.resolve(a),this._defer=null,clearInterval(this._timer))},
entries:function(){var a=this._keys();this._keysToValuesInline(a);return a},_keysToValuesInline:function(a){for(var b=0,c=a.length;b<c;++b)a[b]=h(a[b]).value();return a},_keys:function(){var a=this._getOwnKeys(),b=this._getSubManifestKeys();c.dedupe(a);this._removeExpiredKeys(a);for(var d=0,f=b.length;d<f;++d)0>a.indexOf(b[d])&&a.push(b[d]);return a},_removeExpiredKeys:function(a){for(var b=a.length,c,d,f=h(this._userCacheKey);(c=a[--b])&&(d=h(c));)d.value()||a.splice(b,1);f.value(a);f.expire(31536E6);
f.stale(31536E6);f.save();return a},getBest:function(a){return(this.length()?d.resolve():this._waitForOffer()).then(this.bindTo(function(b){return b?b:this._findBest(a)}))},_waitForOffer:function(){var a=this._defer;a||(a=this._defer=d.defer());this._timer=setInterval(this.bindTo(function(){this.length()&&this._cleanupAfterWait()}),50);return a.promise},_findBest:function(a){var b=this.entries();a&&b.sort(a);return b[0]},length:function(){return this._keys().length},remove:function(){var a=this._manifestCacheEntry,
b=a.value(),c;if(f.$isArray(b))for(var d=b.length-1;0<=d;d--)c=new h(b[d]),c.remove();a.remove()}};return k});BSM.define("bid",["utils","config","microdollar"],function(g,c,f){function d(c,b){this.bidder=b;this.price=new f(c);this.platform=this.bidder.get("platform")}d.prototype={price:null,bidder:null,platform:"",bindTo:g.$bindTo,isValid:function(){return!!this.price&&!!this.price.quantity&&0<this.price.quantity()},expiresIn:function(){return this.bidder.get("expiration")}};return d});
BSM.define("bid/fetcher/decorators/cache","config module logger manifest/manifest utils microdollar bid logger/messages".split(" "),function(g,c,f,d,h,b,k,a){function e(a,b){this.logger=new f(a.logger&&a.logger.prefix+"(cacher)");this.fetcher=a;this.bidder=a.bidder;this.platform=this.fetcher.platform;this.manifest=new d(b,this.bidder.get("expiration"));this.whenFetched=this.bindTo(this.whenFetched);this.whenFetchFailed=this.bindTo(this.whenFetchFailed);this.whenReceived=this.bindTo(this.whenReceived)}
function l(a,b){a=a.price||-1E10;b=b.price||-1E10;return b-a}var p=g.namespace(c.id).get("cache_prefix");e.prototype={bindTo:h.$bindTo,aborted:!1,fetcher:null,platform:"",logger:null,getOffer:function(b,c){var e=this.bidder.get("min_cache_entries"),d=this.manifest.length(),f=this.bidder.get("platform"),g=this.bidder.get("placement_id");d<e?(this.logger.log(a.FETCHING_CACHEABLE_BID,e,d,f,g),this.fetchOffer(b,c)):this.logger.log(a.REUSING_CACHED_BID,e,d,f,g);return this.manifest.getBest(l).then(this.whenReceived)},
abort:function(){this.fetcher.abort();this.aborted=!0},whenReceived:function(c){c=c||{};var e="price"in c&&c.price instanceof b?c.price.quantity():parseInt(c.price,10);isNaN(e)&&(e=-1E3);c.price=new b(e);this.logger.log(a.CACHED_OFFER_RECEIVED,c.price.getCPM(),this.bidder.get("platform"),this.bidder.get("placement_id"));return c},whenFetched:function(a){this.storeCacheContext(a);return a},whenFetchFailed:function(c){this.logger.error(a.BID_REQUEST_REJECTED,this.bidder.get("platform"),c.message);c=
{};c.price=new b(-1E3);c.context={};this.storeCacheContext(c)},storeCacheContext:function(b){var c;c=(new Date).getTime().toString(36);var e=h.random();c=p+"/"+c+e;var e=new k(b.price,this.bidder),d=b.context||{};b.context=d;d.key||(d.key=c);this.logger.log(a.OFFER_CACHED,c,e.expiresIn(),b);this.manifest.add(c,b,e.expiresIn())},fetchOffer:function(a,b){return this.fetcher.getOffer(a,b).then(this.whenFetched,this.whenFetchFailed)}};return e});
BSM.define("utils/jsonp",["when","window","utils/script"],function(g,c,f){return function(d){var h=g.defer(),b="mbid_"+Math.floor(1E12*Math.random()).toString(36);c[b]=h.resolver.resolve;f(d+b);return h.promise}});
BSM.define("urlmaker/aol",[],function(){function g(d){this.settings=d;this.makeUrl=c}function c(c){return[this.settings.base_url,this.settings.aol_network_id,this.settings.aol_placement_id,this.settings.aol_page_id,f[c.size||c.sizes[0]],";noperf=1;alias="+(this.settings.aol_alias||"")+";cmd=bid;cors=yes;"].join("/")}var f={"300x250":170,"728x90":225,"160x600":154,"300x600":529,"320x50":3055};g.platform="AOL";return g});
BSM.define("urlmaker/apn",["module","utils","config"],function(g,c,f){function d(b,d,a,e){e=this.settings.apnh_placement_id;var f=c.isWindowHttps()?"secure_url":"url";a=h.get(f)+"/"+(a||this.settings.request_type)+"?";d=["id="+e,"size="+b.sizes.join(","),"position="+b.position,"reserve="+d.getCPM()];b.pageurl&&d.push("referrer="+b.pageurl);d.push("callback=");return a+d.join("&")}var h=f.namespace(g.id);return function(b){this.settings=b;this.makeUrl=d}});
BSM.define("urlmaker/apnh",["urlmaker/apn"],function(g){return g});BSM.define("urlmaker/brealtime",["module","utils","config"],function(g,c,f){function d(b,c,a,e){a=this.settings.brealtime_placement_id;c=[h.get("url")+"/"+this.settings.request_type+"?id="+a,"size="+b.sizes.join(","),"position="+b.position,"reserve="+c.getCPM()];b.pageurl&&c.push("referrer="+b.pageurl);c.push("callback=");return c.join("&")}var h=f.namespace(g.id);return function(b){this.settings=b;this.makeUrl=d}});
BSM.define("urlmaker/casale",[],function(){function g(){this.makeUrl=c}function c(){function c(a){var b=k[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}function d(a){b.lastIndex=0;return b.test(a)?a.replace(b,c):a}function g(a,b,c){this.initialized=!1;a=parseInt(a,10);if(isNaN(a)||0>a)throw"Invalid Site ID";this.siteID=a;this.impressions=[];this._parseFnName=void 0;top===self?(this.sitePage=location.href,this.topframe=1):(this.sitePage=document.referrer,this.topframe=
0);if("undefined"!==typeof b)if("function"===typeof b)this._parseFnName="cygnus_index_args.parseFn";else throw"Invalid jsonp target function";_IndexRequestData.requestCounter="undefined"===typeof _IndexRequestData.requestCounter?Math.floor(256*Math.random()):(_IndexRequestData.requestCounter+1)%256;this.requestID=String((new Date).getTime()%2592E3*256+_IndexRequestData.requestCounter+256);this.initialized=!0}var b=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
k={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};g.prototype.serialize=function(){var a='{"id":'+this.requestID+',"site":{"page":"'+d(this.sitePage)+'"';"string"===typeof document.referrer&&(a+=',"ref":"'+d(document.referrer)+'"');for(var a=a+'},"imp":[',b=0;b<this.impressions.length;b++){var c=this.impressions[b],e=[],a=a+('{"id":"'+c.id+'", "banner":{"w":'+c.w+',"h":'+c.h+',"topframe":'+String(this.topframe)+"}");"number"===typeof c.bidfloor&&(a+=',"bidfloor":'+c.bidfloor,
"string"===typeof c.bidfloorcur&&(a+=',"bidfloorcur":"'+d(c.bidfloorcur)+'"'));"string"!==typeof c.slotID||c.slotID.match(/^\s*$/)||e.push('"sid":"'+d(c.slotID)+'"');"number"===typeof c.siteID&&e.push('"siteID":'+c.siteID);0<e.length&&(a+=',"ext": {'+e.join()+"}");a=b+1==this.impressions.length?a+"}":a+"},"}return a+"]}"};g.prototype.setPageOverride=function(a){if("string"!==typeof a||a.match(/^\s*$/))return!1;this.sitePage=a;return!0};g.prototype.addImpression=function(a,b,c,e,d,f){var l={id:String(this.impressions.length+
1)};if("number"!==typeof a||1>=a||"number"!==typeof b||1>=b)return null;("string"===typeof d||"number"===typeof d)&&50>=String(d).length&&(l.slotID=String(d));l.w=a;l.h=b;if(void 0!=c&&"number"!==typeof c)return null;if("number"===typeof c){if(0>c)return null;l.bidfloor=c;if(void 0!=e&&"string"!==typeof e)return null;l.bidfloorcur=e}if("undefined"!==typeof f)if("number"===typeof f&&0===f%1&&0<=f)l.siteID=f;else return null;this.impressions.push(l);return l.id};g.prototype.buildRequest=function(){if(0!=
this.impressions.length&&!0===this.initialized){var a=encodeURIComponent(this.serialize()),b="https:"===window.location.protocol?"https://as-sec.casalemedia.com":"http://as.casalemedia.com",b=b+("/headertag?v=9&fn=cygnus_index_parse_res&s="+this.siteID+"&r="+a);"number"===typeof this.timeoutDelay&&0==this.timeoutDelay%1&&0<=this.timeoutDelay&&(b+="&t="+this.timeoutDelay);return b}};try{if("undefined"!==typeof cygnus_index_args&&"undefined"!==typeof cygnus_index_args.siteID&&"undefined"!==typeof cygnus_index_args.slots){"undefined"===
typeof _IndexRequestData&&(_IndexRequestData={impIDToSlotID:{},reqOptions:{}});var a=new g(cygnus_index_args.siteID,cygnus_index_args.parseFn,cygnus_index_args.timeout);cygnus_index_args.url&&"string"===typeof cygnus_index_args.url&&a.setPageOverride(cygnus_index_args.url);_IndexRequestData.impIDToSlotID[a.requestID]={};_IndexRequestData.reqOptions[a.requestID]={};for(var e,l,p=0;p<cygnus_index_args.slots.length;p++)e=cygnus_index_args.slots[p],(l=a.addImpression(e.width,e.height,e.bidfloor,e.bidfloorcur,
e.id,e.siteID))&&(_IndexRequestData.impIDToSlotID[a.requestID][l]=String(e.id));"number"===typeof cygnus_index_args.targetMode&&(_IndexRequestData.reqOptions[a.requestID].targetMode=cygnus_index_args.targetMode);"function"===typeof cygnus_index_args.callback&&(_IndexRequestData.reqOptions[a.requestID].callback=cygnus_index_args.callback);return a.buildRequest()}}catch(m){throw m;}}g.platform="CASALE";return g});
BSM.define("urlmaker/centro",["module","microdollar","utils","config"],function(g,c,f,d){function h(b,c){var a=this.settings.base_url,e={};e.s=this.settings.centro_placement_id;b.pageurl&&(e.url=b.pageurl);e.callback="";e=f.$toString(e,"=","&");return a+"?"+e}d.namespace(g.id);return function(b){this.settings=b;this.makeUrl=h}});
BSM.define("urlmaker/criteo",["module","config"],function(g,c){function f(c){this.settings=c;this.makeUrl=d}function d(c,b){var d=this.settings.criteo_url,a;a=["netId="+this.settings.criteo_nid,"cookieName="+this.settings.criteo_cookie_name,"rnd="+Math.floor(99999999999*Math.random()),"varName="];return d+"?"+a.join("&")}f.platform="CRITEO";return f});
BSM.define("urlmaker/nucleus",["module","config","utils","user"],function(g,c,f,d){function h(){}h.prototype.makeUrl=function(b){var g=c.get("eventlogger/base_url")+"/nucleus/request?",a={u:d.getId(),s:d.getSessionId(),pv_id:d.getPageViewId()},e={};e.v=c.get("version");e.slots=encodeURIComponent(JSON.stringify(b));e.user=encodeURIComponent(JSON.stringify(a));e.cb="";return g+=f.$toString(e)};return h});
BSM.define("urlmaker/openx",["module","microdollar","utils","config"],function(g,c,f,d){function h(a){this.settings=a;this.makeUrl=b}function b(a,b){var c=this.settings.openx_placement_id,d=this.settings.base_url+"/"+k.get("request_type"),g;g=a.firstLook?a.fl_soft_floor:b.quantity();var h=parseInt(a.omk_floor,10)||0;g=h>g?h:g;h={};h.auid=c;g&&(h.aumf=c+":"+g);a.pageurl&&(h.ju=a.pageurl);h.callback="";h=f.$toString(h,"=","&");return d+"?"+h}var k=d.namespace(g.id);h.platform="OXM";return h});
BSM.define("urlmaker/oxm",["module","microdollar","utils","config"],function(g,c,f,d){function h(){this.config=d.namespace(g.id);this.makeUrl=b}function b(b,a){return b.url+"/"+b.request_type+"?nc="+b.oxm_pubId}h.platform="OXM";return h});
BSM.define("urlmaker/pulsepoint",["module","config","document","utils"],function(g,c,f,d){function h(b,c){var a=this.settings,e=a.pulsepoint_publisher_id,l=a.pulsepoint_placement_id,a=a.base_url,g=b.size,h=f.documentElement.clientWidth,n=f.documentElement.clientHeight,r=(new Date).getTimezoneOffset(),t=b.x,q=b.y,e={ca:"BID","if":0,tl:1,cp:e,ct:l,cf:g,dw:h,dh:h+","+n,cwu:b.pageurl,tz:r,ln:d.lang};t&&q&&(e.pxy=[t,q].join());return[a,d.$toString(e,"=","&")].join("?")}c.namespace(g.id);return function(b){this.settings=
b;this.makeUrl=h}});BSM.define("urlmaker","./urlmaker/aol ./urlmaker/apn ./urlmaker/apnh ./urlmaker/brealtime ./urlmaker/casale ./urlmaker/centro ./urlmaker/criteo ./urlmaker/nucleus ./urlmaker/openx ./urlmaker/oxm ./urlmaker/pulsepoint".split(" "));
BSM.define("bid/fetcher/bidfetcher","require module logger utils config urlmaker".split(" "),function(g,c,f,d,h,b){function k(b,c){if(!b)return this;this.bidder=b;this.impression=c;this.platform=b.get("platform")||"";this.settings=b.get("placement_settings");this.logger=new f(this.platform+"["+ ++a+"]")}var a=0;k.prototype={config:null,aborted:!1,logger:null,platform:"",bindTo:d.$bindTo,getOfferSync:function(a,b){return!1},getOffer:function(){throw"Override me";},abort:function(){this.aborted=!0},
getUrlMaker:function(){var a=this.settings.urlmaker;if(a)return a=g(a),new a(this.settings)},getUrl:function(a,b){return this.getUrlMaker(this.settings).makeUrl(a,b)}};return k});BSM.define("offer/displayer/identity",["utils","when","offer/displayer"],function(g,c,f){function d(d){f.apply(this,arguments);this.promise=d||c.resolve()}d.prototype=g.inherit(f,{type:"identity",_getFrame:function(){throw"never call me";}});return d});
BSM.define("bid/fetcher/datastructures",["utils","microdollar","offer/displayer/identity","window","user"],function(g,c,f,d,h){return{createDfpOffer:function(b,c,a){return{price:b,context:{adurl:c,element:a},displayer:new f}},createOrtbBid:function(b,c,a,e,d){return{adid:b,attr:null,price:c,adm:a,adomain:e,ext:d}},createOrtbBidRequest:function(b,c,a){var e=Math.floor(1E12*Math.random()).toString(16),f=c.ext_site_id(),g=c.ext_publisher_id(),m=b.size.split("x"),n=decodeURIComponent(b.pageurl);c={w:m[0],
h:m[1],id:c.ext_placement_id(),pos:b.positionIndex,topframe:d==d.top?1:0};a={bidfloor:a.getCPM(),secure:"https"==d.location.protocol?1:0,banner:c};c=n.split("/").slice(2,3).join("/").split(".");c=2>c.length?"":c.slice(c.length-2,c.length).join(".");n={page:n,domain:c};c={ua:d.navigator.userAgent,js:1};m={id:h.getId()};e={id:e,at:2,imp:[a],site:n,device:c,badv:[],bcat:b.bcat,user:m};b.kw&&(n.content={keywords:b.kw.join(", ")});b.battr&&(a.banner.battr=b.battr);f&&(n.id=f);g&&(n.publisher={id:g});return e},
createOrtbAdContext:function(b){return{adurl:b.adm,adomain:b.adomain&&b.adomain.length?b.adomain.join(","):"",adid:b.adid,nurl:b.nurl,crid:b.crid,cid:b.cid}},createJsonOffer:function(b,c){return{context:{adurl:b},price:c}},createNullOffer:function(){return{context:{adurl:""},price:new c(-1E3)}}}});
BSM.define("bid/fetcher/json","module require window microdollar utils utils/jsonp when ./bidfetcher ./datastructures urlmaker".split(" "),function(g,c,f,d,h,b,k,a,e){function l(b){a.call(this,b)}l.prototype=h.mixin(new a,{getOffer:function(a,c){var e,d;try{e=this.getUrlMaker(this.settings),d=e.makeUrl(a,c,null,this.platform)}catch(f){return k.reject(f)}return b(d).then(this.bindTo(this.buildOffer))},buildOffer:function(a){if(a&&a.result)return this.buildResult(a.result);throw Error("invalid offer data or missing result: "+
a);},buildResult:function(a){var b=a.ad;a=parseInt(a.cpm,10);if(isNaN(a)||!b)a=-1E4;return e.createJsonOffer(b,new d(.1*a))},getUrlMaker:function(a){return new (c(a.urlmaker))(a)}});return l});BSM.define("bid/fetcher/apn","module when utils microdollar bid/fetcher/json offer/displayer/identity".split(" "),function(g,c,f,d,h,b){function k(a){h.call(this,a)}k.prototype=f.mixin(new h,{bindTo:f.$bindTo,getOffer:function(a,b){return h.prototype.getOffer.call(this,a,b)}});return k});
BSM.define("bid/fetcher/brealtime",["./apn"],function(g){return g});BSM.define("impression/displayer/casale",["config"],function(g){return function(c){return"<script>window.top.index_render( document, '"+c+"')\x3c/script>"}});
BSM.define("model/event/gpt/settargeting",[],function(){function g(c){for(var f in g.prototype)f in c&&(this[f]=c[f]);this.event_key&&(this.event_name="gpt.setTargeting."+this.event_key)}g.prototype={key:null,value:null};g.prototype.event_name="gpt.setTargeting";g.prototype.event_key="";return g});
BSM.define("bid/fetcher/casale","when module config utils utils/msgs ./bidfetcher impression/displayer/casale urlmaker/casale microdollar model/event/gpt/settargeting".split(" "),function(g,c,f,d,h,b,k,a,e,l){function p(a,c){b.call(this,a,c);var e=g.defer();this.promise=e.promise;this.resolver=e.resolver;window[t]||(e=this.settings,window[t]={embedMode:e.embedMode||0,timeout:e.timeout||300,siteID:e.casale_siteID,targetMode:1,slots:[]});var e=this.slotID=++A,d=this.settings.casale_placement_id,f=c.size.split("x"),
l=parseInt(f[0]),f=parseInt(f[1]);window[t].slots.push({id:e,width:l,height:f,siteID:d})}function m(){var b=(new a).makeUrl();return d.$script(b).then(x.resolver.resolve,x.resolver.reject)}function n(){return this.resolver.resolve(r.call(this,this.slotID))}function r(a){var b=window[q]||{},c=b[u]||{},e=b[v]||{},d={price:-1E3,context:{}};this.logger.log("received casale response: ",b);Object.keys(e).forEach(function(b){var f=e[b],l=b.split("_");b=l[0]==a?{price:l[1],deal_id:c[b],context:{adurl:f[0]}}:
void 0;b&&(d=b)});return d}c=f.namespace(c.id);var t=c.get("index_args_namespace"),q=c.get("response_namespace"),u=c.get("response_deal_key"),v=c.get("response_cpm_key"),w=0,x=g.defer(),A=0;p.prototype=d.mixin(new b,{promise:null,resolver:null,getOffer:function(a,b){x.promise.ensure(this.bindTo(n));clearTimeout(w);w=setTimeout(m,0);return this.promise}});return p});
BSM.define("bid/fetcher/centro","require microdollar when utils ./json module".split(" "),function(g,c,f,d,h,b){function k(a,b){h.call(this,a,b)}k.prototype=d.mixin(new h,{buildOffer:function(a){a=a||{};var b={},d=parseFloat(a.value);if(isNaN(d)||!d)b.price=new c(-1E3),b.context={};else{b.price=new c(1E3*d);var d=a.adTag,f={};f.size=[a.width,a.height].join("x");f.adurl=d;b.context=f}return b}});return k});
BSM.define("impression/displayer/criteo",["config","document"],function(g,c){var f=g.namespace("impression/displayer/criteo"),d=window.encodeURIComponent,h='<script src="'+f.get("baseUrl")+'?{{QUERY}}">\x3c/script>';return function(b,f){var a=["zoneid="+b,"nodis=1","charset="+(c.charset||c.characterSet||""),"loc="+d(f.page_url)];c.MAX_used&&a.push("exclude="+c.MAX_used);c.referrer&&a.push("referer="+d(c.referrer));c.context&&a.push("context="+d(c.context));"string"==typeof c.MAX_ct0&&0===c.MAX_ct0.indexOf("http")&&
a.push("ct0="+d(c.MAX_ct0));c.mmm_fo&&a.push("mmm_fo=1");a.push("cb=a"+Math.floor(1E9*Math.random()).toString(36));return h.replace("{{QUERY}}",a.join("&"))}});
BSM.define("bid/fetcher/criteo","module require window config microdollar utils utils/script when bid/fetcher/bidfetcher impression/displayer/criteo".split(" "),function(g,c,f,d,h,b,k,a,e,l){function p(){e.apply(this,Array.prototype.slice.call(arguments,0));this.settings.urlmaker=this.settings.urlmaker||r}function m(){var a=n.get("var_name");return(f[a]||"").split(";")}var n=d.namespace(g.id),r=n.get("urlmaker"),t=n.get("delay"),q=0,u=a.defer();p.prototype=b.mixin(new e,{getOffer:function(a){var b=
this.getUrl()+n.get("var_name");clearTimeout(q);q=setTimeout(function(){k(b).then(m).then(u.resolver.resolve,u.resolver.reject)},t);return u.promise.then(this.bindTo(this.buildOffer))},buildOffer:function(a){var b=this.settings.criteo_key,c=this.settings.criteo_placement_id,e=this.settings.criteo_floor||0,d=this.impression,f={},g={};g.context=f;g.price=new h(-1E3);if(!b||0>a.indexOf(b))return g;f.adurl=l(c,d);g.price=new h(e);return g}});return p});
BSM.define("bid/loaddfp",["module","config","utils","window"],function(g,c,f,d){function h(){a||(b(),a=!0)}function b(){f.$script(k.get("gpt_url"));e.cmd.push(function(){e.pubads().collapseEmptyDivs();e.pubads().enableAsyncRendering();e.pubads().enable()})}var k=c.namespace(g.id),a=!1,e=function(){var a=k.get("gpt_ns");return d[a]=d[a]||{cmd:[]}}();h.googleTag=e;return h});
BSM.define("bid/fetcher/dfp","module config logger microdollar utils when bid/fetcher/bidfetcher ../loaddfp bid/fetcher/datastructures window document logger/messages".split(" "),function(g,c,f,d,h,b,k,a,e,l,p,m){function n(c,e){a();k.apply(this,Array.prototype.slice.call(arguments,0));var d=b.defer(),f=this.settings;this.ceiling=f.ceiling;this.increments=f.increments;this.postreadywaittime=f.postreadywait;this.resolver=d.resolver;this.promise=d.promise;this.promise.ensure(this.bindTo(this.unregisterMessageHandler))}
var r=c.namespace(g.id),t={};n.prototype=h.mixin(new k,{ceiling:0,completed:!1,context:null,element:null,id:"",increments:0,messageHandler:null,offer:null,postreadywaittime:0,promise:null,reserve:null,resolver:null,getOffer:function(a,b){var c=h.floorToIncrement(b.quantity(),this.increments,this.ceiling);this.context=a;this.reserve=new d(c+this.increments);if(this.aborted||!this.getUnit()||this.reserve.gt(new d(this.ceiling)))return this.rejectOffer(Error(g.id+": getOffer() called after abort"));
this.registerMessageHandlers();this.makeElement();this.sendDfpCall();return this.promise},rejectOffer:function(a){this.removeElement();a=a||Error(g.id+": offer request rejected");return this.resolver.reject(a)},sendOffer:function(){this.completed=!0;var a=e.createDfpOffer(this.reserve,this.element.id,this.element);this.resolver.resolve(a)},sendDfpCall:function(){a.googleTag.cmd.push(this.bindTo(this.onGpt))},onGpt:function(){this.logger.log(m.BUILDING_GPT_SLOT,this.getId());this._buildSlot()},abort:function(){if(!this.completed){var a=
Error(g.id+": in-flight request aborted");this.aborted=!0;this.logger.log(m.DFP_BIDDER_ABORT,this.getId());this.rejectOffer(a)}},removeElement:function(){if(this.element&&this.element.parentNode){this.logger.log(m.DFP_ELEMENT_REMOVED,this.getId());for(var a=this.element.getElementsByTagName("iframe"),b=0,c=a.length;b<c;b++)try{this._stopFrame(a[b])}catch(e){}this.element.parentNode.removeChild(this.element)}},makeElement:function(){if(this.element)return this.element;var a=this.context.container.appendChild(p.createElement("div"));
a.id=this.getId();return this.element=a},getUnit:function(){var a=this.settings.dfp_placement_id;0===a.indexOf("/")&&(a=a.substring(1));return this.unit=a},getId:function(){if(this.id)return this.id;if(!this.context)return"";for(var a=0,b=["bsm_cx/dfp",this.getUnit(),this.context.sizes[0],a];b.join("/")in t;)b[b.length-1]=++a;this.id=b.join("/");t[this.id]=!0;return this.id},_buildSlot:function(){var b=this.context,c=this.reserve.quantity(),e=b.sizes[0].split("x"),d=parseInt(e[0],10),f=parseInt(e[1],
10),e=this.getId(),g=this.getUnit(),l=a.googleTag,h=l.pubads(),c=l.defineSlot(g,[d,f],e).addService(h).set("page_url",decodeURIComponent(b.pageurl)).setTargeting("cxid",e).setTargeting("cximp",b.id).setTargeting("reserve",c),k=this,m=c.renderEnded;c.renderEnded=function(){k._onRenderEnd();"function"==typeof m&&m.apply(this,arguments)};if(!h.enableAsyncRendering())return this.rejectOffer(Error("GPT async unavailable"));for(var p in b.kv)c.setTargeting(p,b.kv[p].toString());l.enableServices();l.display(e)},
_onRenderEnd:function(){function a(){e.logger.log(m.DFP_POST_READY_WAIT_COMPLETE,d);e.sendOffer()}function b(a){e.logger.log(m.DFP_OFFER_REJECT,d);return e.rejectOffer(a)}var c=this.element,e=this,d=this.getId();this.logger.log(m.DFP_ON_RENDER_END,d,this.postreadywaittime);"none"===c.style.display?(this.logger.log(m.DFP_HIDDEN_SLOT,d),b(Error(g.id+": no ad displayed, bad dfp setup"))):(e.logger.log(m.DFP_ON_FRAME_READY,d,this.postreadywaittime),setTimeout(a,this.postreadywaittime))},_stopFrame:function(a){var b=
a.contentWindow||a.contentDocument&&a.contentDocument.window;a=b.document||a.contentDocument||a.contentWindow.document;b&&b.stop?b.stop():a&&a.execCommand&&a.execCommand("Stop")},registerMessageHandlers:function(){var a=this.messageHandler=this.bindTo(this.onMessage);l.addEventListener?l.addEventListener("message",a,!1):l.attachEvent&&l.attachEvent("onmessage",a)},onMessage:function(a){a=a||l.event;a=a.data;var b;var c=r.get("pixel_key");b=a.indexOf(c);var d=a.indexOf("=no"),c=c.length;0>b||d<b?b=
!1:(b=a.substr(b+c,d-b-c).split("|"),b=b.pop()||"");b&&(this.logger.log(m.DFP_REJECT_MESSAGE_RECEIVED,a),this.resolver.resolve(e.createNullOffer()),this.removeElement())},unregisterMessageHandler:function(){l.removeEventListener?l.removeEventListener("message",this.messageHandler,!1):l.detachEvent&&l.detachEvent("onmessage",this.messageHandler);this.messageHandler=null}});return n});
BSM.define("bid/fetcher/null","module microdollar utils when ./bidfetcher config".split(" "),function(g,c,f,d,h,b){function k(a){if(!arguments.length)return this;h.call(this,a)}k.prototype=f.mixin(new h,{getOffer:function(){return d.resolve(this.getNullBid())},mustFill:function(){return!1},getNullBid:function(){return{context:null,price:new c(-1E3)}}});return k});
BSM.define("bid/fetcher/openx","require microdollar when utils ./json module".split(" "),function(g,c,f,d,h,b){function k(a,b){h.call(this,a,b)}function a(a,b){a=e(a);b=e(b);return b-a}function e(a){var b=parseInt(a.pub_rev,10);a=a.cpipc;return b>a?b:a}k.prototype=d.mixin(new h,{buildOffer:function(b){b=(b.ads||{}).ad||[];b=b.sort(a);var d=b.shift();b={};if(d){b.price=new c(e(d));var d=d||{},f=(d.creatives||[]).shift()||{},g=d.html,h=f.tracking||{},k={};k.size=[f.width,f.height].join("x");k.adurl=
g;k.adid=d.adid;k.nurl=h.impression;b.context=k}else b.price=new c(-1E3),b.context={};return b}});return k});
BSM.define("utils/fetch",["module","config","window","when","logger/messages"],function(g,c,f,d,h){return function(b,c,a){var e=d.defer();a=a||(c?"POST":"GET");"object"==typeof c&&c&&JSON.stringify(c);var g;try{if(f.ActiveXObject)g=new f.ActiveXObject("Microsoft.XMLHTTP");else if(f.XMLHttpRequest)g=new f.XMLHttpRequest;else throw Error(h.NO_XHR_SUPPORT);}catch(p){return e.resolver.reject(p)}"withCredentials"in g&&(g.withCredentials=!0);g.onreadystatechange=function(){4==g.readyState&&(200==g.status||
204==g.status?e.resolver.resolve(g.responseText):e.resolver.reject(Error(h.XHR_REQUEST_FAILED+b)))};g.open(a,b,1);g.send(c);return e.promise}});
BSM.define("bid/fetcher/ortb","module microdollar utils ./bidfetcher utils/fetch when ./datastructures".split(" "),function(g,c,f,d,h,b,k){function a(a){d.call(this,a);this.multiplier=this.settings.price_multiplier}function e(a){var b=[k.createOrtbBid(0,-100,"",[],{})],c;try{a=JSON.parse(a)}catch(e){a=""}if(!a||!a.seatbid||!a.seatbid.length)return b;a=a.seatbid||[];for(var d=0,f=a.length;d<f;d++){c=a[d]&&a[d].bid||[];for(var g=0,h=c.length;g<h;g++)b.push(c[g])}return b}var l=k.createOrtbBidRequest,
p=k.createOrtbAdContext;a.prototype=f.mixin(new d,{getOffer:function(a,d){d=d||new c(0);var f=(this.settings.request_type||"GET").toUpperCase(),g,k;try{g=this.getUrl(a,d)}catch(p){return b.reject(p)}"POST"==f&&(k=l(a,this.bidder,d),k=JSON.stringify(k));return h(g,k,f).then(e).then(this.bindTo(this.buildOffer))},buildOffer:function(a){for(var b=-1E6,e,d,f=0,g=a.length;f<g;f++)!(d=a[f])||d.price<=b||(b=d.price,e=d);a=e;b={};e=new c(((a?a.price:-100)*this.multiplier).toFixed(0));b.price=e;b.context=
p(a);return b}});return a});
BSM.define("bid/fetcher/oxm","when utils ./bidfetcher urlmaker/oxm ./datastructures microdollar module".split(" "),function(g,c,f,d,h,b,k){function a(a,b){f.call(this,a);var c=g.defer(),e=this.settings.oxm_placement_id,d="oxm_"+b.id+"_"+e,h=b.oxm_targeting;this.promise=c.promise;this.resolver=c.resolver;this.bidder=a;this.requestId=d;c=[e,b.sizes,d];h&&c.push({pos:[h]});window.OX_dfp_ads=window.OX_dfp_ads||[];window.OX_dfp_ads.push(c)}function e(a){var c=a.ad;a=10*parseInt(a.price,10);a=new b(Math.round(c?
a:-1E3));return h.createJsonOffer(c,a)}var l=!1;a.prototype=c.mixin(new f,{promise:null,resolver:null,getOffer:function(a,b){var e=(new d).makeUrl(this.settings),f=this;if(l)l.then(function(){f.buildResult(OX.dfp_bidder.getPriceMap())});else{var h=g.defer();window.oxDone=function(){f.buildResult(OX.dfp_bidder.getPriceMap());h.resolver.resolve()};l=h.promise;c.$script(e).then(function(){}).otherwise(function(){f.buildResult({})})}return this.promise},buildOffer:function(a){},buildResult:function(a){a=
a[this.requestId];if(!a)return this.resolver.resolve(e({}));this.resolver.resolve(e(a))}});return a});
BSM.define("utils/frame_locator",["module","logger","window","document"],function(g,c,f,d){function h(a,c){var d,f=-1;try{d=c.frames,f=d.length}catch(g){b.warn("unable to access frame list of win")}for(var k=0;k<f;k++){var r=d[k];if(r==a||~h(a,r))return k}return-1}var b=new c(g.id),k=d.getElementsByTagName("iframe");return function(a){if(a==f)return d.documentElement;a=h(a,f);a=window.frames[a];for(var b,c=0,g=k.length;c<g;c++){try{b=k[c].contentWindow}catch(m){continue}if(a==b)return k[c]}return!1}});
BSM.define("utils/mercury","module window document config logger utils utils/msgs utils/frame_locator".split(" "),function(g,c,f,d,h,b,k,a){function e(c){c=c||m.event;var e=c.data,d=r.get("msg_data_regex");c=c.source;var f;if(!("string"!=typeof e||0>e.indexOf(d))){element=a(c);d=(c=l(element))&&c.id;var g=r.get("msg_data_regex");if(e=e.substr(g.length).match(/^([^=]+)=?(.*)/)){try{f=JSON.parse(e[2])}catch(h){f={value:e[2]}}e={type:e[1],value:f}}else e=void 0;f=e.value;e=[e.type];b.mergeDefaults(f,
c);d&&e.push(d);k.fire(e,f)}}function l(a){var b,c=q.length;if(!a)return null;do{if(b=a.id&&a.id.substr(0,c)===q?a.id:a.getAttribute(t))return a=p(a),a.id=b,a;a=a.parentNode}while(a!=n);return null}function p(a){var b={};r.get("data_attribute_keys").forEach(function(c){var e=c.replace(/\-.*/,"");b[e]=a.getAttribute("data-"+c)});return b}var m=c,n=f;new h(g.id);var r=d.namespace(g.id),t=r.get("id_attribute_name"),q=r.get("cx_id_prefix");m.addEventListener?m.addEventListener("message",e,!0):m.attachEvent&&
m.attachEvent("onmessage",e)});
BSM.define("bid/fetcher/pubmatic","module utils microdollar bid/fetcher/bidfetcher when config document window utils/friendlyiframe utils/msgs logger utils/mercury".split(" "),function(g,c,f,d,h,b,k,a,e,l,p){function m(a,b){d.call(this,a,b);w[b.id]=null}function n(){var a=v.getElementsByTagName("head")[0],b;b=B.slice(0);var c=y;b[c.SLOT_LIST]=JSON.stringify(r(w));b[c.PUB_ID]=w.length?w[0].bidder.get("placement_settings").pubmatic_publisher_id:"";b[c.SCRIPT_URL]=u.get("script_url");b=b.join("");e(b,
a,{width:0,height:0})}function r(){return w.map(function(a){return a.bidder}).map(t)}function t(a){return a.get("placement_settings").pubmatic_placement_id}function q(a){var b={},c="";for(a=a.split(";");a.length;)c=a.shift(),b[c]=a.shift();return b}var u=b.namespace(g.id),v=k,w=[],x={},A,z=new p(g.id);b=u.get("callback_name");var B=["<script>pm_optimize_adslots = ",null,';pm_pub_id = "',null,'";pm_async_callback_fn = "'+b+'";\nwindow["'+b+'"] = '+function(a){window.parent.postMessage("bsm.pixelEvent:bid.fetcher.pubmatic.bids="+
JSON.stringify({bids:window.progKeyValueMap,tags:window.bidDetailsMap}),"*")}.toString()+'\x3c/script><script src="',null,'">\x3c/script>'],y={SLOT_LIST:1,PUB_ID:3,SCRIPT_URL:5};m.prototype=c.mixin(new d,{getOffer:function(a,b){var c=h.defer(),e=t(this.bidder);clearTimeout(A);A=setTimeout(n,0);w.push(this);x[e]=x[e]||[];x[e].push(this);this.resolver=c.resolver;return c.promise},buildOffer:function(b,c){var e=Math.round(1E3*(b.bid||0)),e={context:{bid_id:b.bidid,adurl:a.decodeURIComponent(c.creative_tag),
size:[c.width,c.height].join("x"),nurl:a.decodeURIComponent(c.tracking_url)},deal_id:b.wdeal,price:new f(e)};z.log("collected bid: ",e);return this.resolver.resolve(e)}});l.listen(g.id.replace(/\//g,".")+".bids",function(b){b=b||a.event;var c=b.detail.data;b=c.bids;var c=c.tags,e,d,f;for(f in b)if(e=x[f]){d=e.shift();d.buildOffer(q(b[f]),c[f]);d=0;for(var g=e.length;d<g;d++)e[d].resolver.reject(Error("multi-fetch for same slot id not supported"))}});return m});
BSM.define("bid/fetcher/rubicon","module utils bid/fetcher/bidfetcher config when microdollar document window".split(" "),function(g,c,f,d,h,b,k,a){function e(a,b){f.call(this,a,b)}function l(){var a=this.settings,a={siteId:a.rubicon_site_id,zoneId:a.rubicon_placement_id,id:this.impression.id,sizes:t(this.impression.sizes)},a=z.defineSlot(a);a.setPosition(this.impression.slot);return a}function p(){var a=this.slot.getRawResponses().sort(m),a=a.length?a.shift():D;return this.buildOffer(a)}function m(a,
b){return a.cpm-b.cpm}function n(a){if(!A){var b;(b=r())||(c.$script(v+a.rubicon_account_id+".js"),b=x);var e=b;A=!0;z=e[w]=e[w]||{};B=z.cmd=z.cmd||[];B.push(function(){z=e[w];B=z.cmd})}}function r(){for(var a=x,b=a.top;a!=b;)try{if(a[w])return a}finally{a=a.parent}return a[w]?a:null}function t(a){return a.map(function(a){return a in u?u[a]:0})}var q=d.namespace(g.id),u=q.get("size_map");q.get("bidder_code");var v=q.get("header_url"),w=q.get("namespace"),x=a,A=!1,z,B,y=['<script>;(function(t, d) {t.renderCreative(d, "',
null,'", ',null,") })(window.parent.",null,"(), document.body||document.documentElement)\x3c/script>"],D={cpm:-1E3,dimensions:[]};e.prototype=c.mixin(new f,{getOffer:function(a,b){n(this.settings);var c=h.defer();this.resolver=c.resolver;B.push(this.bindTo(function(){var a=q.get("integration_code");this.slot=l.apply(this);z.run(this.bindTo(p,this.slot),{slots:[this.slot]});z.setIntegration(a)}));return c.promise},buildOffer:function(a){a=a||{};var c=(a.dimensions||[]).join("x"),e=Math.round(1E3*parseFloat(a.cpm||
0,10)),d=this.impression.id,f=y.slice(0),g=u[c];f[1]=d;f[3]=g;f[5]="mbid_get_rubicon_tag";a={context:{adurl:f.join(""),size:c},deal_id:a.deal,advertiser_id:a.advertiser,price:new b(e)};return this.resolver.resolve(a)},bindTo:c.$bindTo});a.mbid_get_rubicon_tag=function(){var a=r();return a?a[w]:null};return e});
BSM.define("bid/fetcher/sonobi","module config utils ./bidfetcher when utils/jsonp microdollar".split(" "),function(g,c,f,d,h,b,k){function a(a,b){d.call(this,a,b);m[b.id]=this.bidder.ext_placement_id()}function e(){var a=t.get("base_url"),a=a+JSON.stringify(m);b(a+"&cv=").then(r.resolver.resolve,r.resolver.resolve);m={};r=h.defer()}function l(a){if(!(this.impression.id in a.slots))throw Error("Response contains no bid for id "+this.impression.id);var b=(a.slots||{})[this.impression.id];a=Math.round(1E3*
parseFloat(b.sbi_mouse));var c={},e={};"sbi_dozer"in b&&(e.deal_id=b.sbi_dozer);var b=b.sbi_aid,d=p.slice(0);d[1]=t.get("creative_url");d[3]=b;b=d.join("");c.adurl=b;e.context=c;e.price=new k(a);return e}var p=['<script src="',null,"?aid=",null,'">\x3c/script>'],m={},n=0,r=h.defer(),t=c.namespace(g.id);a.prototype=f.mixin(new d,{getOffer:function(a,b){clearTimeout(n);n=setTimeout(e,0);return r.promise.then(this.bindTo(l))}});return a});
BSM.define("bid/fetcher/tag",["module","when","utils","./bidfetcher","microdollar"],function(g,c,f,d,h){function b(){d.apply(this,arguments)}function k(a,b,c){a={price:new h(a),context:{adurl:b}};c&&(c.type="sync",a.displayer=c);return a}b.prototype=f.mixin(new d,{context:null,abort:function(){},getOffer:function(a,b){var d=this.bidder.get("bias"),d=this.checkOffer(this.settings,d,b,void 0);return c.resolve(d)},checkOffer:function(a,b,c,d){if(!a)return k(-1E3,"",d);var f=a.html;a=k(a.price,f,d);b=
a.price.clone().multiplyBy(b);c.gt(b)&&(a=k(-1E3,f,d));return a}});return b});
BSM.define("impression/displayer/xaxis",["config"],function(g){var c=g.namespace("impression/displayer/xaxis").get("slot_ids");return function(f,d){var g=c[d];return'<span id="TFSA_'+g+"\"><script type=\"text/javascript\">var tfsa_click = '[PUBLISHER CLICK MACRO]';var tfsa_imp = '[PUBLISHER IMPRESSION MACRO]'; var tfsa_pb = 'http://cdn.beanstock.com/pub/px/bsmpixel.js?no';var tfsa_pbt = 'j';var tfsa_uid = '[USER ID]';var tfsa_pub = '"+f+"';var tfsa_pos = '"+g+"';tfsa_rn = new String(Math.random());tfsa_rns = tfsa_rn.substring (2,12);document.write('<scr' + 'ipt type=\"text/javascript\" src=\"//network.realmedia.com/2/247-Access/Pub/"+
f+"/' + tfsa_rns + '@x96?\"></scr' + 'ipt>');\x3c/script></span>"}});
BSM.define("bid/fetcher/xaxis","module when utils utils/msgs ./bidfetcher microdollar bid/fetcher/datastructures impression/displayer/xaxis offer/displayer/friendly logger/messages".split(" "),function(g,c,f,d,h,b,k,a,e,l){function p(){h.apply(this,arguments);this.defer=c.defer();this.sendRejectOffer=this.bindTo(this.sendRejectOffer)}function m(a,c){return{price:new b(a),context:{adurl:"",displayer:c}}}p.prototype=f.mixin(new h,{context:null,displayer:null,fulfilled:!1,iframe:null,defer:null,offerAmount:0,
timer:0,abort:function(){this.sendRejectOffer()},mustFill:function(){return!0},getOffer:function(a,b){if(b.quantity()>this.offerAmount)return this.sendRejectOffer();this.offerAmount=this.settings.floor;this.embedTag();return this.defer.promise},sendValidOffer:function(a){this.logger.log(l.XAXIS_OFFER_RESOLVED,this.fulfilled);if(this.fulfilled)return this.defer.promise;this.fulfilled=!0;this.iframe=a;var b=this.defer,c=this.offerAmount,e=this.displayer;this.timer=window.setTimeout(function(){b.resolver.resolve(m(c,
e))},this.settings.postreadywait)},sendRejectOffer:function(){var a=this.defer.resolver,b=this.context&&this.context.id||"";this.logger.log(l.XAXIS_OFFER_REJECTED,this.fulfilled);if(this.fulfilled)return this.defer.promise;this.fulfilled=!0;window.clearTimeout(this.timer);this.iframe&&this.iframe.parentNode&&(this.iframe.parentNode.innerHTML="");d.off(["offer.revoked",b],this.sendRejectOffer);return a.resolve(k.createNullOffer())},embedTag:function(){var b=this.context,c=a(this.settings.xaxis_placement_id,
b.size),f=this.displayer=new e;d.on(["offer.revoked",b.id],this.sendRejectOffer);f.display(c,b).then(this.bindTo(this.sendValidOffer))}});return p});BSM.define("impression/displayer/yieldbot",["config"],function(g){var c=g.get("impression/displayer/yieldbot/lib_url");return function(f,d){return'<script type="text/javascript" src="'+c+'">\x3c/script><script type="text/javascript">var ybotq = ybotq || [];ybotq.push(function () {yieldbot.renderAd("'+(f+":"+d)+'");});\x3c/script>'}});
BSM.define("bid/fetcher/yieldbot","module logger config microdollar utils when window document bid/fetcher/bidfetcher impression/displayer/yieldbot user/cache".split(" "),function(g,c,f,d,h,b,k,a,e,l,p){function m(b,c){u=k.ybotq||(k.ybotq=[]);e.call(this,b,c);if(!k.yieldbot){var d=this.settings.lib_url,f=a.createElement("script");f.src=d;d=a.getElementsByTagName("script")[0];d.parentNode.insertBefore(f,d)}}function n(){u.push(function(){v=k.yieldbot;t.forEach(function(a){a.defineYieldBotSlot()});
v.enableAsync();v.go()});u.push(function(){t.forEach(function(a){a.buildOffer(v.getSlotCriteria(a.settings.yieldbot_placement_id))})})}function r(a){return a.split("x")}var t=[],q=0,u,v,w=f.namespace(g.id);m.prototype=h.mixin(new e,{defer:null,getOffer:function(a){a=b.defer();var c=this.settings.yieldbot_placement_id;this.resolver=a.resolver;if(c)t.push(this);else return a.resolve(createOffer({}));clearTimeout(q);q=setTimeout(n);return a.promise},buildOffer:function(a){(a.ybot_ad||"").toLowerCase();
var b=this.settings.yieldbot_placement_id,c=parseInt(a.ybot_cpm,10);a=a.ybot_size;b={price:isNaN(c)?-1E3:c*w.get("price_multiplier"),context:{adurl:l(b,a)}};return this.resolver.resolve(b)},defineYieldBotSlot:function(){var a={sizes:this.impression.sizes.map(r)};v.pub(this.settings.yieldbot_publisher_id);v.defineSlot(this.settings.yieldbot_placement_id,a)},getOfferSync:function(){this.logger.error("getOfferSync not supported");throw Error("not supported");},mustFill:function(){return!1}});return m});
BSM.define("bid/fetcher/factory","module require logger manifest/bidderkeygen bid/fetcher/decorators/cache bid/fetcher/apn bid/fetcher/bidfetcher bid/fetcher/brealtime bid/fetcher/casale bid/fetcher/centro bid/fetcher/criteo bid/fetcher/datastructures bid/fetcher/dfp bid/fetcher/json bid/fetcher/null bid/fetcher/openx bid/fetcher/ortb bid/fetcher/oxm bid/fetcher/pubmatic bid/fetcher/rubicon bid/fetcher/sonobi bid/fetcher/tag bid/fetcher/xaxis bid/fetcher/yieldbot".split(" "),function(g,c,f,d,h){function b(){}
function k(b,d){var f=null;b=[d,b].join("/");try{f=c(b)}catch(g){return a.error('cannot require fetcher "'+b+'": '+g.message),k("null",d)}return f}var a=new f(g.id);b.prototype.build=function(a,b){var c=a.shouldFetch(b.context)?a.get("bidder_type"):"null",c=new (k(c,this.path))(a,b.context),f=a.get("placement_id"),f=d(f,b.context);return b.context.useCache()&&a.get("cacheable")?new h(c,f):c};b.prototype.path="bid/fetcher";return b});
BSM.define("service/bidfetcher","module when logger logger/messages when/timeout bid/fetcher/factory offer utils utils/msgs microdollar config".split(" "),function(g,c,f,d,h,b,k,a,e,l,p){function m(){this.fetchBid=this.bindTo(n);this.logger=new f(g.id);this.abort=this.bindTo(q)}function n(e,d){if(a.isWindowHttps()&&!e.get("secure"))return c.reject(Error("Cannot place secure bid"));var f=e.get("placement_id"),g=(new b).build(e,d),l=e.get("maxduration");this.bidder=e;this.fetcher=g;f=g.getOffer(d.context,
d.reserve).then(this.bindTo(r,d,f));return h(l,f).otherwise(this.bindTo(t))}function r(a,b,c){this.logger.log(d.BID_COLLECTED,c.price.getCPM(),this.bidder.get("platform"),b,a.name(),a,c);if(c.price.gte(u))throw Error("bid value of $"+c.price.getCPM()+" exceeds maximum value of $"+u.getCPM());b=["offer.received",a.context.id,b].join(".");a=new k(c.price,c.context,a,this.bidder,c.displayer);e.fire(b,a);this.fetcher=null;return a}function t(a){a=a instanceof Error?a:Error("bid fetcher timeout");this.logger.warn(d.DFP_REJECT_MESSAGE_RECEIVED,
a.message);throw a;}function q(){this.fetcher=null}p=p.namespace(g.id);var u=new l(p.get("max_offer_value"));m.prototype.bindTo=a.$bindTo;m.prototype.abort=function(){};return m});
BSM.define("model/bidder","when utils microdollar model/model bidder/manifest service/bidfetcher".split(" "),function(g,c,f,d,h,b){function k(a){this.offer({context:{adurl:""},price:new f(-1E3)});this.floor(0);for(var b in a){var c=a[b];if("function"===typeof this[b])this[b](c);else this.set(b,c)}a=this.placement_settings=this.placement_settings||{};this.floor(parseInt(a.price||a.ceiling||0,10))}function a(a){return function(){return this.placement_settings[this.platform+"_"+a+"_id"]}}k.prototype=
{abort:function(){this.fetcher&&this.fetcher.abort()},bias:1,bidder_type:"null",cacheable:!1,"default":!1,delivery_cap:{limit:Infinity,period:2592E6,skips:null},expiration:6E4,ext_placement_id:a("placement"),ext_site_id:a("site"),ext_publisher_id:a("publisher"),flag:!1,flag_must_bid:!1,flag_page_only:!1,_floor:new f(0),floor:function(a){if(!a)return this.get("_floor");try{a=new f(a)}catch(b){a=new f(0)}return this.set("_floor",a)},invalid_cap:{limit:3,period:3E5,skips:3},site_id:function(){},min_cache_entries:1,
maxduration:2E3,_offer:null,offer:function(a,b){return"object"===typeof a?this.set("_offer",a):"undefined"!==typeof a&&"undefined"!==typeof b?this.set("_offer",{context:{adurl:b},price:new f(a)}):this.get("_offer")},passback_cap:{limit:Infinity,period:2592E6},_phase:"two",phase:function(){var a=["zero","one","two","three"];return function(b){b=isNaN(parseInt(b,10))?b:parseInt(b,10);null!=b&&("number"===typeof b&&b<a.length&&(b=a[b]),this.set("_phase",b));return this.get("_phase")}}(),platform:"unk",
placement_id:0,pricing_type:"first",priority:500,secure:!1,share:0,sendBidCall:function(a){this.fetcher=new b;return this.fetcher.fetchBid(this,a)},getOfferSync:function(a,c){this.fetcher=new b;return this.fetcher.fetchSyncBid(this,c)},shouldFetch:function(a){this.manifest||(this.manifest=new h(this,this.get("platform"),a));var b;if(b=this.manifest.shouldFetch(a)){b=a.firstLook;var c=a.reprime;a=a.flag;var d=this.get("prefetch_only");b=!b&&!a&&!d||b&&(!d||d&&!c)||a&&!d}return b},getPlacementId:function(){}};
return k=d.extend(k)});BSM.define("offer/null","impression offer microdollar when config utils offer/displayer/noop model/bidder".split(" "),function(g,c,f,d,h,b,k,a){function e(){var b=new g({}),e=new f(-1E3),d=new a({});c.call(this,e,{},b,d,new k)}e.prototype=b.inherit(c,{isClaimed:function(){return!1}});return e});
BSM.define("bid/selector","microdollar logger bid/ranker bid/pricer impression offer/null".split(" "),function(g,c,f,d,h,b){function k(a){this.offers=[];this.pricer=new d(a);this.ranker=new f(this.pricer);this.addOffer(new b);this._cleared=!1}k.prototype={_winner:null,_cleared:!1,ranker:null,offers:null,addOffer:function(a){this.offers.push(a);this.ranker.rank(a)},getCurrentWinner:function(){return this.ranker.getFirst()},getCurrentClearPrice:function(){return this.pricer.get(this._winner||this.ranker.getFirst(),
this.ranker.getSecond())},getClearPriceList:function(){for(var a=[],b=0,c=this.offers.length,d,f;b<c;b++)(d=this.offers[b])&&d.isValid()&&(f=this.ranker.getSecondByOffer(d),f=this.pricer.get(d,f),a.push({price:f.quantity(),platform:d.offeredBy.platform}));return a},clear:function(){if(this._winner&&this._winner.isValid())return this._winner;var a=this.ranker.getFirst(),b=this.pricer.get(a,this.ranker.getSecond());a.setPrice(b,!0);this.setWinner(a);return a},setWinner:function(a){this._winner=a;return this},
hasCleared:function(){return this._cleared},getWinner:function(){return this._winner},reclear:function(){this._cleared=!1;this._winner=null},find:function(a){a=a?a.toUpperCase():"";for(var b=this.offers,c=0,d=this.offers.length;c<d;++c)if(b[c].getPlatform().toUpperCase()===a)return b[c];return null}};return k});
BSM.define("nucleus/nucleus_element",["module","config","window"],function(g,c,f){function d(){a:{var a=f.top,c=f.document;try{a.document&&(c=a.document)}finally{break a}}for(var a=c.querySelectorAll("img,script"),c=a.length,d;c--;){d=a[c];var g;a:{var h=d;g=b.get("attribute_prefix");for(var h=h.attributes,k=void 0,r=0,t=h.length;r<t;r++)if(k=h[r],0===k.nodeName.indexOf(g)){g=!0;break a}g=void 0}if(g)return d}}function h(){if(f==f.top)return!0;try{return!!f.top.document}catch(a){return!0}}var b=c.namespace("model/nucleus/nucleus_tag"),
k=d();return function(){return k?k:h()?null:k=d()}});
BSM.define("model/nucleus/nucleus_tag",["module","nucleus/nucleus_element","utils","config","document"],function(g,c,f,d,h){var b=["sizes","slot_list"],k=d.namespace(g.id);return function(){var a=c()||h.createElement("script"),e;if(e=a){e={};var d=k.get("default_attributes"),g=k.get("attribute_prefix"),m,n,r;for(r in d)m=g+r,n=d[r],r=r.replace(/-/g,"_"),e[r]=n,(m=a.getAttribute(m))&&(e[r]=m),(f.$isArray(n)||0<=b.indexOf(r))&&"string"==typeof e[r]&&(e[r]=e[r].split(/[,\s;]+/g))}return e}});
BSM.define("bidder/factory",["module","model/bidder","model/nucleus/nucleus_tag","logger"],function(g,c,f,d){function h(a){var b=f().platform_list,c=a.platform;return b&&b.length&&0>b.indexOf(c)?(k.log(d.messages.PLATFORM_FILTERED,a.platform,a.placement_id,b),!1):!0}function b(a,b){a=a.get("priority");b=b.get("priority");return a-b}var k=new d(g.id);return function(a,d){function f(b){return a.isFirstLook()?b.flag:!0}var g=a.bidders||[],g=g.filter(h);a.isFirstLook()&&(g=g.filter(f));return g.map(function(b){b=
new c(b);var d=a.biases||{},e=b.get("platform");b.set("bias",d[e]||1);return b}).sort(b)}});
BSM.define("auction/strategy/strategy",["module","logger","utils","when","logger/messages"],function(g,c,f,d,h){function b(a){if(!arguments.length)return this;var b=d.defer();this.resolver=b.resolver;this.promise=b.promise;this.resource=a;this.outstanding=[];this.aborted=!1;this.logger=new c(this.type)}function k(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return a.splice(c,1)}b.prototype={aborted:!1,logger:null,outstanding:null,pending:null,promise:null,resolver:null,resource:null,type:"super",
bindTo:f.$bindTo,ask:function(){this.logger.error(h.ABSTRACT_METHOD_ERROR,g.id,"ask");throw Error("Ask not overridden by subclass");},start:function(a){if(!a.length)return d.resolve();this.pending=a.slice(0);this.ask();return this.promise},restart:function(){var a=d.defer();this.aborted=!1;this.resolver=a.resolver;this.promise=a.promise;return this.start(this.pending)},abort:function(){if(!this.aborted){var a=this.outstanding,b;for(this.aborted=!0;b=a.shift();)b.abort();this.resolver.resolve().done()}},
send:function(a){if(this.aborted)return this.aborted;this.logger.log(h.SENDING_BID_REQUEST,a.platform);this.outstanding.push(a);return a.sendBidCall(this.resource).then(this.bindTo(this.collect),this.bindTo(this.errorHandler,a))},errorHandler:function(a,b){k(this.outstanding,a);this.logger.log(h.BID_REQUEST_REJECTED,a.platform,b.message);return this.done()?this.resolver.resolve():this.ask()},collect:function(a){var b=a.offeredBy;a.hasBid()?a.getPrice().getCPM():b.getFloor().getCPM();k(this.outstanding,
b);return this.done()?this.resolver.resolve():this.ask()},done:function(){return this.aborted||0===this.outstanding.length&&0===this.pending.length}};return b});BSM.define("auction/strategy/serial",["utils","./strategy","module"],function(g,c,f){function d(d){c.apply(this,arguments)}d.prototype=g.mixin(new c,{type:f.id,ask:function(){if(this.pending.length)return this.send(this.pending.shift())}});return d});
BSM.define("auction/strategy/dutch",["utils","./serial","module","logger/messages","microdollar"],function(g,c,f,d,h){function b(a){c.apply(this,arguments)}function k(a,b){a=a||{};a=a.floor&&a.floor()||new h(0);b=b||{};b=b.floor&&b.floor()||new h(0);return b.quantity()-a.quantity()}var a=c.prototype.start,e=c.prototype.collect,l=c.prototype.done;b.prototype=g.mixin(new c,{type:f.id,finished:!1,done:function(){return this.finished||l.apply(this)},start:function(b){b=b.slice(0).sort(k);return a.call(this,
b)},collect:function(a){a&&a.isValid()&&(this.finished=!0);return e.call(this,a)}});return b});
BSM.define("auction/strategy/phase","require config utils when ./strategy module logger/messages".split(" "),function(g,c,f,d,h,b,k){function a(a){h.apply(this,arguments);this.strategies=c.get("auction/strategy/phase/strategy");this.pending=null}a.prototype=f.mixin(new h,{bidders:null,current:null,phases:null,strategies:null,type:b.id,ask:new Function,abort:function(){this.logger.log(k.PHASE_ABORTED);this.aborted=!0;this.current&&this.current.abort()},start:function(a){this.phases=["one","two","three"];
this.logger.log(k.PHASE_STARTING,a);for(var b={},c=a.length,d,f,g=0;g<c;++g)f=a[g],d=f.phase(),d=b[d]=b[d]||[],d.push(f);this.bidders=b;return this.startPhase()},restart:function(){this.aborted=!1;return this.current&&this.current.pending.length?this.current.restart():this.startPhase()},startPhase:function(a){var b;if(!this.phases.length||this.aborted)return d.resolve();a?b=this.current.bidders:(b=this.getNextStrategy(),a=b[0],b=b[1]);return(this.current=a)?this.current.start(b).then(this.bindTo(this.clearPhase,
this.phase,this.type)):this.startPhase()},getNextStrategy:function(){var a=this.phase=this.phases.shift(),b=this.bidders[a]||[],c=this.type=this.strategies[a]||"parallel";if(!b.length)return this.logger.log(k.PHASE_STARTED_NO_BIDDERS,a,c),[null,[]];this.logger.log(k.PHASE_STARTED,a,c);var a=this.resource,d=g("./factory"),c=d?d(c,a):void 0;return[c,b]},clearPhase:function(a,b){this.logger.log(k.PHASE_CLEARED,a,b);return this.startPhase()}});return a});
BSM.define("auction/strategy/parallel",["utils","./strategy","module"],function(g,c,f){function d(d){c.apply(this,arguments)}d.prototype=g.mixin(new c,{type:f.id,ask:function(){for(var c=this.pending,b,d=c.length;d--;)b=c.shift(),this.send(b)}});return d});
BSM.define("auction/strategy/factory",["./dutch","./phase","./serial","./parallel"],function(g,c,f,d){var h={phase:c,dutch:g,serial:f,parallel:d};return function(b,c){if(!(b in h))return new TypeError(b+" not a valid strategy");var a=new h[b](c);a.type=b;return a}});
BSM.define("auction/builder","utils logger user bid/selector bidder/factory auction/strategy/factory microdollar".split(" "),function(g,c,f,d,h,b,k){return function(a){var e=a.resource.context,g=e.getSoftFloor();a.floor=e.getFloor();f.initialize(e);a.logger=new c(a.resource.name());var k;k=e.isFirstLook()?100:e.maxduration;k=parseInt(k,10);a.timeout=k;k=parseFloat(e.increment);a.incrementBidBy=k;a.bidders=h(e,a.biases);a.bidSelector=new d(g);a.strategy=b(e.strategy,a.resource)}});
BSM.define("auction/open",["module","utils/msgs"],function(g,c){function f(c){var b=c.bidders;c=c.floor;for(var d=0,a=b.length;d<a;++d)c.gt(b[d].floor())&&b[d].floor(c)}var d=g.id.replace("/",".");return function(g){var b=["offer.received",g.resource.context.id],k=g.collect;g.startTime=(new Date).getTime();f(g);c.listen(b,function(a){g.collect(a.detail.data)});c.fire(d,g);return g.strategy.start(g.bidders).then(g.check).then(g.clear).then(g.close).otherwise(g.error).ensure(function(){c.unlisten(b,
k)})}});BSM.define("auction/checkwinner",["when","logger"],function(g,c){return function(f,d){var h=d.isClaimed(),b=d.offeredBy.platform,k=d.resource.getCPM();f.logger.log(c.messages.OFFER_CHECKED,b,k,h?"UN":"");if(!h)return g(d);f.logger.warn(c.messages.OFFER_CLAIMED,d);return f.strategy.start([d.offeredBy]).then(f.check)}});
BSM.define("auction/collect",[],function(){return function(g,c){var f=c.bidSelector,d=c.incrementBidBy,h=c.resource,b=h.reserve;f.addOffer(g);f=f.getCurrentClearPrice();d=f.gte(b)?f.clone().multiplyBy(d):b;h.reserve=d;return g}});
BSM.define("auction/clear",["config","microdollar"],function(g,c){return function(f){var d=f.bidSelector,h=d.clear(),b=f.resource.context;h&&h.isValid()||(h=g.get("auction/default_bidder"),d=d.find(h),b.getFloor().quantity(),d&&d.canDisplay()&&!d.isClaimed()?(d.setPrice(new c(0)),d.passback=!0,h=d):h=null);if(!h)throw Error("cannot clear auction without valid winner");f.clearedPrice=h.getPrice();h.claim();return h}});
BSM.define("model/event/nucleus/priceupdate",["module","model/event"],function(g,c){var f=g.id.replace(/\//g,".").replace("model.event.","");return c.extend({event_name:f,event_key:"",slot_key:"",gross_offer:"",platform_name:"",pricing_type:"",price_list:[],bid_list:[],impression:{},targeting_key:""})});
BSM.define("model/event/nucleus/complete",["module","model/event"],function(g,c){var f=g.id.replace(/\//g,".").replace("model.event.","");return c.extend({event_name:f,event_key:"",slot_key:"",duration:0,bid_list:[],price_list:[],impression:null})});
BSM.define("nucleus","utils utils/msgs when config impression user/cache auction/builder auction/open auction/collect model/event/nucleus/priceupdate model/event/nucleus/complete manifest/bidderkeygen manifest/manifest window".split(" "),function(g,c,f,d,h,b,k,a,e,l,p,m,n,r){function t(a){var b=a.context;b.firstLook=!0;b.strategy="parallel";b.soft_floor=b.fl_soft_floor;this.resource=a;this.slotSuffix=b.positionIndex;this.collect=this.bindTo(v);this.check=this.bindTo(w);this.clear=this.bindTo(x);this.close=
this.bindTo(A);b.bidders.filter(q).forEach(this.bindTo(u));k(this)}function q(a){return a.flag_page_only}function u(a){a=m(a.placement_id,this.resource.context);(new n(a)).remove()}function v(a){e(a,this);var b=a.offeredBy.platform,d=this.resource.context,f=this.bidSelector.getClearPriceList(),g=d.getSlotKey(),b={event_key:g,slot_key:g,gross_offer:a.getGrossPrice().quantity(),platform_name:b,pricing_type:a.getPricingType(),bid_list:f,impression:d,price_list:f.map(B)};c.fire(new l(b));return a}function w(a){return a}
function x(){this.duration=(new Date).getTime()-this.startTime;var a=this.bidSelector.getClearPriceList(),b=this.resource.context.getSlotKey();c.fire(new p({event_key:b,slot_key:b,duration:this.duration,price_list:a.map(B),bid_list:a,impression:this.resource.context}));return this.bidSelector.clear()}function A(){return this}var z=d.namespace("flag"),B=function(a){return function(b){return b[a]}}("price");t.prototype={bidSelector:null,bidders:null,floor:null,incrementBidBy:0,logger:null,resource:null,
strategy:null,timeout:0,bindTo:g.$bindTo,start:function(){var c=z.get("enabled"),d=z.get("cache_prefix")+"/enabled";b(d).value(c).expire(432E5).save();c&&a(this)},abort:function(){return this.strategy.abort()},isHeader:function(){return!0}};t.open=function(a){a=new h(a);return(new t(a)).start()};return t});
BSM.define("controller/data_bus/filled",["model/event/offer/displayed","auction/databus/sendevent"],function(g,c){function f(d){d=d||window.event;d=d.detail.data;var b=d.impression,f=d.bidder,a=d.offer;d={winner:f.get("platform"),impression:b,placement_id:f.get("placement_id"),flag:b.flag,price:d.price,injection_type:a.displayer.type};c("filled",d)}var d=!1;return{init:function(){if(!d)g.on(f);d=!0}}});
BSM.define("controller/tracker/store-creative",["module","logger","config","model/event/offer/displayed","user/cache"],function(g,c,f,d,h){function b(b){var c=b.detail.data;b={timestamp:new Date,context:c.context,placement_id:c.placement_id,platform:c.platform};var c=c.impression.pub_zone,d=h(a.get("cache_key")),f=d.value()||{};d.expire(a.get("expiry")).value(k(f,c,b)).save()}function k(b,c,d){var f=b[c]||[];f.unshift(d);f=f.slice(0,a.get("max_entries"));b[c]=f;return b}new c(g.id);var a=f.namespace(g.id);
return function(){d.on(b)}});
BSM.define("auction","when utils utils/msgs window document impression microdollar auction/databus/sendevent auction/builder auction/open auction/checkwinner auction/collect auction/clear nucleus user/session logger/messages controller/data_bus/filled controller/tracker/store-creative".split(" "),function(g,c,f,d,h,b,k,a,e,l,p,m,n,r,t,q,u,v){function w(a){this.resource=a;this.defer=g.defer();this.collect=this.bindTo(A);this.check=this.bindTo(z);this.clear=this.bindTo(B);this.close=this.bindTo(y);
this.error=this.bindTo(D);this.reconcile=this.bindTo(H);this.onRevoked=this.bindTo(E);this.onTimeout=this.bindTo(x);e(this);f.listen(["offer.revoked",this.resource.context.id],this.onRevoked);f.listen(["offer.update",this.resource.context.id],this.reconcile);t.incAuctionCount(this.resource.context)}function x(){this.hasWinner()?(this.logger.error(q.AUCTION_TIMEOUT),this.abort()):(this.logger.log(q.TIMEOUT_NO_WINNER,this.timeout),this.auctionTimer=setTimeout(this.onTimeout,this.timeout))}function A(a){this.logger.log(q.OFFER_COLLECTED,
a.offeredBy.get("platform"),a.mustFill(),a.isValid());return m(a,this)}function z(){var a=this.resource.context.id,b=this.bidSelector.getCurrentWinner();if(!b)throw Error(a+":asked to check winner but no offers available");return p(this,b)}function B(){this.winner=n(this);this.logger.log(q.AUCTION_CLEARED,this.resource.name(),this.winner.offeredBy.platform,this.clearedPrice.getCPM());clearTimeout(this.auctionTimer);return this.winner}function y(){this.duration=(new Date).getTime()-this.startTime;
this.logger.log(q.AUCTION_CLOSED);this.winner.display(this.resource.context);this.sendNotification();a(!0===this.winner.passback?"passback":"cleared",this);return this}function D(b){this.duration=(new Date).getTime()-this.startTime;clearTimeout(this.auctionTimer);this.error=b;a("error",this);return g.reject(b)}function H(b){if(!this.winner.passback){var c=b.winner;b=b.price;a("revoked",this);c&&this.winner.offeredBy.setPlatform(c);b&&(c=new k(b),this.winner.setPrice(c),this.clearedPrice=c);a("cleared",
this)}}function E(){this.logger.log(q.AUCTION_REVOKED);var b=this.winner;a("revoked",this);b.revoke();this.resource.reserve=this.bidSelector.getCurrentClearPrice();this.strategy.restart().then(this.clear).then(this.close).otherwise(this.error)}w.prototype={constructor:w,auctionTimer:0,biases:null,bidders:null,bidSelector:null,clearedPrice:null,defer:null,duration:0,floor:null,incrementBidBy:0,logger:null,resource:null,startTime:0,strategy:null,timeout:0,winner:null,bindTo:c.$bindTo,open:function(){var a=
this.defer.resolver;this.logger.log(q.AUCTION_OPEN,this.resource);this.auctionTimer=setTimeout(this.onTimeout,this.timeout);l(this).then(a.resolve,a.reject);return this.defer.promise},hasWinner:function(){return 0<this.bidSelector.getCurrentClearPrice().quantity()},abort:function(){this.strategy.abort()},sendNotification:function(){var a=this.winner.getNotifyUrl(),b=this.resource.context.container,c;a&&(c=h.createElement("iframe"),c.width=c.height=c.frameBorder=0,c.style.visibility="hidden",c.setAttribute("src",
a),b.appendChild(c))},isHeader:function(){return!1}};w.open=w.openAuction=function(a){t.incStartCount();a=new b(a);return(new w(a)).open()};u.init();v();return w});BSM.define("cx",function(){});BSM.require(["main"]);
